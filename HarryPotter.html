<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üßô‚Äç‚ôÇÔ∏è L'√âcole des Sortil√®ges - Aventure Magique</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Crimson Text', serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8d5b7;
            overflow-x: hidden;
        }

        .magic-particles {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 4px; height: 4px;
            background: gold;
            border-radius: 50%;
            animation: float 15s infinite;
            opacity: 0.6;
            box-shadow: 0 0 10px gold;
        }

        @keyframes float {
            0%, 100% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
        }

        #title-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(180deg, #0a0a1a 0%, #1a1a3a 50%, #2a1a4a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        #title-screen h1 {
            font-family: 'Cinzel', serif;
            font-size: 3.5em;
            color: #ffd700;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.5), 0 0 60px rgba(255, 215, 0, 0.3);
            text-align: center;
            margin-bottom: 20px;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 30px rgba(255, 215, 0, 0.5); }
            to { text-shadow: 0 0 50px rgba(255, 215, 0, 0.8), 0 0 80px rgba(255, 215, 0, 0.4); }
        }

        #title-screen .subtitle {
            font-size: 1.5em;
            color: #b8a88a;
            margin-bottom: 50px;
            font-style: italic;
        }

        .start-btn {
            font-family: 'Cinzel', serif;
            padding: 20px 60px;
            font-size: 1.5em;
            background: linear-gradient(135deg, #8B0000 0%, #5c0000 100%);
            color: #ffd700;
            border: 3px solid #ffd700;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .start-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        }

        #character-creation {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(10, 10, 30, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999;
            padding: 20px;
            overflow-y: auto;
        }

        #character-creation h2 {
            font-family: 'Cinzel', serif;
            font-size: 2.5em;
            color: #ffd700;
            margin-bottom: 30px;
        }

        .creation-form {
            background: rgba(30, 30, 60, 0.8);
            padding: 40px;
            border-radius: 20px;
            border: 2px solid #4a4a8a;
            max-width: 600px;
            width: 100%;
        }

        .form-group { margin-bottom: 25px; }

        .form-group label {
            display: block;
            font-size: 1.2em;
            margin-bottom: 10px;
            color: #c9b896;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            background: rgba(20, 20, 40, 0.8);
            border: 2px solid #5a5a9a;
            border-radius: 10px;
            color: #e8d5b7;
            font-family: 'Crimson Text', serif;
        }

        .form-group input:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }

        .house-selection {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .house-btn {
            padding: 20px;
            border: 3px solid transparent;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            color: #e8d5b7;
        }

        .house-btn.griffeor { background: linear-gradient(135deg, #740001, #ae0001); }
        .house-btn.serpentis { background: linear-gradient(135deg, #1a472a, #2a623d); }
        .house-btn.aquilon { background: linear-gradient(135deg, #0e1a40, #222f5b); }
        .house-btn.blairaud { background: linear-gradient(135deg, #372e29, #5c5046); }

        .house-btn:hover, .house-btn.selected {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.5);
            border-color: #ffd700;
        }

        .house-btn h3 {
            font-family: 'Cinzel', serif;
            font-size: 1.3em;
            margin-bottom: 5px;
        }

        .house-btn p { font-size: 0.9em; opacity: 0.8; }
        .house-btn .emoji { font-size: 2em; margin-bottom: 10px; }

        #game-container {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        #game-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: linear-gradient(135deg, rgba(30, 30, 60, 0.9), rgba(20, 20, 50, 0.9));
            border-radius: 15px;
            border: 2px solid #4a4a8a;
            margin-bottom: 20px;
            gap: 15px;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .player-avatar {
            width: 50px; height: 50px;
            border-radius: 50%;
            border: 3px solid #ffd700;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            background: rgba(0, 0, 0, 0.3);
        }

        .player-details h3 {
            font-family: 'Cinzel', serif;
            color: #ffd700;
            font-size: 1.2em;
        }

        .player-details p { font-size: 0.85em; opacity: 0.8; }

        .stats-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .stat { text-align: center; }

        .stat-label {
            font-size: 0.75em;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-family: 'Cinzel', serif;
            font-size: 1.3em;
            color: #ffd700;
        }

        .bar-container {
            width: 120px;
            height: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
        }

        .health-bar { height: 100%; background: linear-gradient(90deg, #ff4444, #ff6666); transition: width 0.5s; }
        .mana-bar { height: 100%; background: linear-gradient(90deg, #4444ff, #6666ff); transition: width 0.5s; }
        .xp-bar { height: 100%; background: linear-gradient(90deg, #ffd700, #ffec8b); transition: width 0.5s; }

        #main-area {
            display: grid;
            grid-template-columns: 220px 1fr 250px;
            gap: 20px;
        }

        @media (max-width: 1000px) {
            #main-area { grid-template-columns: 1fr; }
            #nav-panel, #side-panel { order: 2; }
            #content-area { order: 1; }
        }

        #nav-panel, .panel-section {
            background: linear-gradient(180deg, rgba(30, 30, 60, 0.9), rgba(20, 20, 50, 0.9));
            border-radius: 15px;
            border: 2px solid #4a4a8a;
            padding: 15px;
        }

        #nav-panel h3, .panel-section h4 {
            font-family: 'Cinzel', serif;
            color: #ffd700;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.1em;
        }

        .nav-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(60, 60, 100, 0.5);
            border: 2px solid #5a5a9a;
            border-radius: 10px;
            color: #e8d5b7;
            font-family: 'Crimson Text', serif;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-btn:hover {
            background: rgba(80, 80, 130, 0.7);
            border-color: #ffd700;
            transform: translateX(5px);
        }

        .nav-btn.active {
            background: rgba(139, 0, 0, 0.5);
            border-color: #ffd700;
        }

        .nav-btn .icon { font-size: 1.2em; }

        #content-area {
            background: linear-gradient(180deg, rgba(25, 25, 50, 0.95), rgba(15, 15, 40, 0.95));
            border-radius: 15px;
            border: 2px solid #4a4a8a;
            padding: 25px;
            min-height: 500px;
        }

        #content-area h2 {
            font-family: 'Cinzel', serif;
            color: #ffd700;
            margin-bottom: 20px;
            font-size: 1.6em;
            border-bottom: 2px solid #4a4a8a;
            padding-bottom: 15px;
        }

        .story-text {
            font-size: 1.1em;
            line-height: 1.8;
            margin-bottom: 20px;
        }

        .story-text p { margin-bottom: 15px; }

        .dialogue-box {
            background: rgba(40, 40, 80, 0.6);
            border-left: 4px solid #ffd700;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 10px 10px 0;
        }

        .dialogue-speaker {
            font-family: 'Cinzel', serif;
            color: #ffd700;
            font-size: 1.05em;
            margin-bottom: 8px;
        }

        .dialogue-text {
            font-style: italic;
            line-height: 1.6;
        }

        .choice-container { margin-top: 30px; }

        .choice-btn {
            display: block;
            width: 100%;
            padding: 15px 20px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, rgba(60, 60, 100, 0.6), rgba(40, 40, 80, 0.6));
            border: 2px solid #5a5a9a;
            border-radius: 12px;
            color: #e8d5b7;
            font-family: 'Crimson Text', serif;
            font-size: 1.05em;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .choice-btn:hover {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.6), rgba(100, 0, 0, 0.6));
            border-color: #ffd700;
            transform: translateX(10px);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        #side-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .quest-item {
            background: rgba(40, 40, 80, 0.5);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #ffd700;
        }

        .quest-item.completed { border-left-color: #44ff44; opacity: 0.6; }
        .quest-item.active { border-left-color: #ff8800; background: rgba(255, 136, 0, 0.1); }

        .quest-title {
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
        }

        .quest-desc { font-size: 0.8em; opacity: 0.8; }
        .quest-reward { font-size: 0.75em; color: #ffd700; margin-top: 5px; }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        .inventory-slot {
            aspect-ratio: 1;
            background: rgba(20, 20, 40, 0.8);
            border: 2px solid #3a3a6a;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .inventory-slot:hover {
            border-color: #ffd700;
            transform: scale(1.1);
        }

        .inventory-slot .item-count {
            position: absolute;
            bottom: 2px; right: 4px;
            font-size: 0.55em;
            color: #ffd700;
        }

        .spell-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .spell-item {
            background: rgba(40, 40, 80, 0.5);
            padding: 8px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .spell-item:hover {
            border-color: #6666ff;
            background: rgba(60, 60, 120, 0.5);
        }

        .spell-icon { font-size: 1.3em; }
        .spell-info { flex: 1; }
        .spell-name { font-weight: bold; font-size: 0.9em; }
        .spell-cost { font-size: 0.75em; color: #6666ff; }

        #combat-screen {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(10, 10, 20, 0.98);
            z-index: 500;
            padding: 20px;
            overflow-y: auto;
        }

        .combat-arena {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            min-height: 100%;
        }

        .combat-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .combat-header h2 {
            font-family: 'Cinzel', serif;
            color: #ff4444;
            font-size: 2em;
        }

        .combatants {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            padding: 20px;
        }

        .combatant {
            text-align: center;
            padding: 25px;
            background: rgba(30, 30, 60, 0.8);
            border-radius: 20px;
            border: 3px solid #4a4a8a;
            min-width: 200px;
        }

        .combatant.player-side { border-color: #4444ff; }
        .combatant.enemy-side { border-color: #ff4444; }

        .combatant-avatar { font-size: 4em; margin-bottom: 10px; }

        .combatant-name {
            font-family: 'Cinzel', serif;
            font-size: 1.3em;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .combatant-health {
            width: 150px;
            height: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            overflow: hidden;
            margin: 0 auto;
        }

        .combatant-health-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4444, #ff6666);
            transition: width 0.5s;
        }

        .combat-vs {
            font-family: 'Cinzel', serif;
            font-size: 2.5em;
            color: #ffd700;
        }

        .combat-log {
            background: rgba(20, 20, 40, 0.8);
            border-radius: 10px;
            padding: 15px;
            max-height: 120px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .combat-log p { margin-bottom: 5px; font-size: 0.9em; }
        .combat-log .damage { color: #ff6666; }
        .combat-log .heal { color: #66ff66; }
        .combat-log .info { color: #6666ff; }

        .combat-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .combat-btn {
            padding: 12px 25px;
            font-family: 'Cinzel', serif;
            font-size: 1em;
            background: linear-gradient(135deg, #4a4a8a, #3a3a6a);
            border: 2px solid #6a6aba;
            border-radius: 10px;
            color: #e8d5b7;
            cursor: pointer;
            transition: all 0.3s;
        }

        .combat-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #6a6aba, #5a5aaa);
            transform: scale(1.05);
        }

        .combat-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .combat-btn.attack { border-color: #ff6666; }
        .combat-btn.spell { border-color: #6666ff; }
        .combat-btn.item { border-color: #66ff66; }
        .combat-btn.flee { border-color: #ffaa00; }

        .map-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .map-location {
            background: rgba(40, 40, 80, 0.6);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #4a4a8a;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .map-location:hover:not(.locked) {
            border-color: #ffd700;
            transform: scale(1.05);
        }

        .map-location.current { border-color: #44ff44; background: rgba(40, 80, 40, 0.6); }
        .map-location.locked { opacity: 0.4; cursor: not-allowed; }
        .map-location .location-icon { font-size: 2.5em; margin-bottom: 10px; }
        .map-location h4 { font-family: 'Cinzel', serif; color: #ffd700; font-size: 0.95em; }

        .notification {
            position: fixed;
            top: 20px; right: 20px;
            padding: 15px 25px;
            background: linear-gradient(135deg, rgba(40, 40, 80, 0.95), rgba(30, 30, 60, 0.95));
            border: 2px solid #ffd700;
            border-radius: 15px;
            color: #e8d5b7;
            font-size: 1em;
            z-index: 1000;
            animation: slideIn 0.5s ease;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
        }

        .notification.success { border-color: #44ff44; }
        .notification.danger { border-color: #ff4444; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .spell-effect {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 6em;
            animation: spellPop 1s ease forwards;
            z-index: 600;
            pointer-events: none;
        }

        @keyframes spellPop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }

        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .shop-item {
            background: rgba(40, 40, 80, 0.6);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #4a4a8a;
            text-align: center;
            transition: all 0.3s;
        }

        .shop-item:hover { border-color: #ffd700; }
        .shop-item .item-icon { font-size: 2.5em; margin-bottom: 10px; }
        .shop-item h4 { color: #ffd700; margin-bottom: 5px; }
        .shop-item .price { color: #ffcc00; font-size: 1.1em; margin: 10px 0; }

        .buy-btn {
            padding: 8px 20px;
            background: linear-gradient(135deg, #228B22, #006400);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-family: 'Crimson Text', serif;
            transition: all 0.3s;
        }

        .buy-btn:hover { transform: scale(1.1); }
        .buy-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="magic-particles" id="particles"></div>

    <!-- √âCRAN TITRE -->
    <div id="title-screen">
        <h1>üè∞ L'√âcole des Sortil√®ges</h1>
        <p class="subtitle">Une aventure magique vous attend...</p>
        <button class="start-btn" onclick="showCharacterCreation()">‚ú® Commencer l'Aventure</button>
    </div>

    <!-- CR√âATION PERSONNAGE -->
    <div id="character-creation">
        <h2>üßô‚Äç‚ôÇÔ∏è Cr√©ation de votre Sorcier</h2>
        <div class="creation-form">
            <div class="form-group">
                <label>Votre nom de sorcier :</label>
                <input type="text" id="player-name" placeholder="Entrez votre nom..." maxlength="20">
            </div>
            <div class="form-group">
                <label>Choisissez votre maison :</label>
                <div class="house-selection">
                    <div class="house-btn griffeor" onclick="selectHouse('Griffeor', this)">
                        <div class="emoji">ü¶Å</div>
                        <h3>Griffeor</h3>
                        <p>Courage et bravoure</p>
                    </div>
                    <div class="house-btn serpentis" onclick="selectHouse('Serpentis', this)">
                        <div class="emoji">üêç</div>
                        <h3>Serpentis</h3>
                        <p>Ambition et ruse</p>
                    </div>
                    <div class="house-btn aquilon" onclick="selectHouse('Aquilon', this)">
                        <div class="emoji">ü¶Ö</div>
                        <h3>Aquilon</h3>
                        <p>Sagesse et savoir</p>
                    </div>
                    <div class="house-btn blairaud" onclick="selectHouse('Blairaud', this)">
                        <div class="emoji">ü¶°</div>
                        <h3>Blairaud</h3>
                        <p>Loyaut√© et travail</p>
                    </div>
                </div>
            </div>
            <button class="start-btn" style="width: 100%; margin-top: 20px;" onclick="startGame()">
                ‚ö° Entrer √† l'√âcole
            </button>
        </div>
    </div>

    <!-- INTERFACE JEU -->
    <div id="game-container">
        <header id="game-header">
            <div class="player-info">
                <div class="player-avatar" id="player-avatar">üßô</div>
                <div class="player-details">
                    <h3 id="display-name">Sorcier</h3>
                    <p id="display-house">Maison</p>
                </div>
            </div>
            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-label">‚ù§Ô∏è Sant√©</div>
                    <div class="bar-container">
                        <div class="health-bar" id="health-bar"></div>
                    </div>
                </div>
                <div class="stat">
                    <div class="stat-label">üíô Mana</div>
                    <div class="bar-container">
                        <div class="mana-bar" id="mana-bar"></div>
                    </div>
                </div>
                <div class="stat">
                    <div class="stat-label">‚≠ê Niv.</div>
                    <div class="stat-value" id="level-display">1</div>
                </div>
                <div class="stat">
                    <div class="stat-label">üí∞ Or</div>
                    <div class="stat-value" id="gold-display">50</div>
                </div>
            </div>
        </header>

        <main id="main-area">
            <nav id="nav-panel">
                <h3>üìç Navigation</h3>
                <button class="nav-btn active" onclick="navigate('story')"><span class="icon">üìñ</span> Histoire</button>
                <button class="nav-btn" onclick="navigate('quests')"><span class="icon">üìú</span> Qu√™tes</button>
                <button class="nav-btn" onclick="navigate('map')"><span class="icon">üó∫Ô∏è</span> Carte</button>
                <button class="nav-btn" onclick="navigate('spells')"><span class="icon">‚ú®</span> Sorts</button>
                <button class="nav-btn" onclick="navigate('inventory')"><span class="icon">üéí</span> Inventaire</button>
                <button class="nav-btn" onclick="navigate('shop')"><span class="icon">üè™</span> Boutique</button>
            </nav>

            <section id="content-area">
                <div id="story-content"></div>
            </section>

            <aside id="side-panel">
                <div class="panel-section">
                    <h4>üìú Qu√™te Active</h4>
                    <div id="active-quest"></div>
                </div>
                <div class="panel-section">
                    <h4>‚ú® Sorts</h4>
                    <div class="spell-list" id="quick-spells"></div>
                </div>
                <div class="panel-section">
                    <h4>üéí Objets</h4>
                    <div class="inventory-grid" id="quick-inventory"></div>
                </div>
            </aside>
        </main>
    </div>

    <!-- √âCRAN COMBAT -->
    <div id="combat-screen">
        <div class="combat-arena">
            <div class="combat-header"><h2>‚öîÔ∏è COMBAT ‚öîÔ∏è</h2></div>
            <div class="combatants">
                <div class="combatant player-side">
                    <div class="combatant-avatar" id="combat-player-avatar">üßô</div>
                    <div class="combatant-name" id="combat-player-name">Joueur</div>
                    <div class="combatant-health">
                        <div class="combatant-health-fill" id="combat-player-health"></div>
                    </div>
                    <p style="margin-top: 10px;"><span id="combat-player-hp">100</span> PV</p>
                </div>
                <div class="combat-vs">‚ö°</div>
                <div class="combatant enemy-side">
                    <div class="combatant-avatar" id="combat-enemy-avatar">üëπ</div>
                    <div class="combatant-name" id="combat-enemy-name">Ennemi</div>
                    <div class="combatant-health">
                        <div class="combatant-health-fill" id="combat-enemy-health"></div>
                    </div>
                    <p style="margin-top: 10px;"><span id="combat-enemy-hp">50</span> PV</p>
                </div>
            </div>
            <div class="combat-log" id="combat-log"></div>
            <div class="combat-actions" id="combat-actions"></div>
        </div>
    </div>

<script>
// ==================== DONN√âES DU JEU ====================
let game = {
    player: {
        name: '',
        house: '',
        level: 1,
        xp: 0,
        xpToNext: 100,
        health: 100,
        maxHealth: 100,
        mana: 100,
        maxMana: 100,
        gold: 50,
        attack: 15,
        defense: 5
    },
    inventory: [
        { id: 'potion', name: 'Potion de Soin', icon: 'üß™', count: 3, effect: 'heal', value: 40 },
        { id: 'mana_potion', name: 'Potion de Mana', icon: 'üíô', count: 2, effect: 'mana', value: 50 }
    ],
    spells: [
        { id: 'lumos', name: 'Lumos', icon: 'üí°', cost: 5, damage: 0, desc: 'Illumine les t√©n√®bres' },
        { id: 'stupefix', name: 'Stup√©fix', icon: '‚ö°', cost: 20, damage: 30, desc: 'Attaque paralysante' },
        { id: 'incendio', name: 'Incendio', icon: 'üî•', cost: 35, damage: 50, desc: 'Boule de feu' },
        { id: 'protego', name: 'Protego', icon: 'üõ°Ô∏è', cost: 15, damage: 0, desc: 'Bouclier magique' }
    ],
    quests: [
        { id: 'q1', title: 'Premier Jour', desc: 'Explorez l\'√©cole et trouvez votre dortoir', active: true, completed: false, reward: { xp: 50, gold: 25 } },
        { id: 'q2', title: 'Le Myst√®re de la Biblioth√®que', desc: 'Enqu√™tez sur les bruits √©tranges', active: false, completed: false, reward: { xp: 100, gold: 50 } },
        { id: 'q3', title: 'L\'Ombre des Cachots', desc: 'D√©couvrez le secret des cachots', active: false, completed: false, reward: { xp: 150, gold: 100 } }
    ],
    locations: {
        entrance: { name: 'Grande Entr√©e', icon: 'üö™', unlocked: true },
        hall: { name: 'Grande Salle', icon: 'üèõÔ∏è', unlocked: true },
        library: { name: 'Biblioth√®que', icon: 'üìö', unlocked: true },
        classroom: { name: 'Salle de Cours', icon: 'üéì', unlocked: true },
        dormitory: { name: 'Dortoir', icon: 'üõèÔ∏è', unlocked: true },
        forbidden: { name: 'Section Interdite', icon: '‚ö†Ô∏è', unlocked: false },
        dungeons: { name: 'Cachots', icon: 'üïØÔ∏è', unlocked: false },
        tower: { name: 'Tour d\'Astronomie', icon: 'üî≠', unlocked: false },
        forest: { name: 'For√™t Interdite', icon: 'üå≤', unlocked: false }
    },
    currentLocation: 'entrance',
    storyScene: 'intro',
    flags: {},
    combat: null
};

// ==================== ENNEMIS ====================
const enemies = {
    goblin: { name: 'Gobelin Mal√©fique', icon: 'üë∫', health: 40, attack: 8, xp: 30, gold: 15 },
    ghost: { name: 'Fant√¥me Furieux', icon: 'üëª', health: 50, attack: 12, xp: 45, gold: 20 },
    spider: { name: 'Araign√©e G√©ante', icon: 'üï∑Ô∏è', health: 60, attack: 15, xp: 60, gold: 30 },
    troll: { name: 'Troll des Cachots', icon: 'üëπ', health: 100, attack: 20, xp: 100, gold: 50 },
    dark_wizard: { name: 'Mage Noir', icon: 'üßô‚Äç‚ôÇÔ∏è', health: 80, attack: 25, xp: 120, gold: 75 },
    shadow: { name: 'L\'Ombre', icon: 'üë§', health: 150, attack: 30, xp: 200, gold: 100 }
};

// ==================== SC√àNES DE L'HISTOIRE ====================
const storyScenes = {
    intro: {
        title: 'Chapitre 1 : L\'Arriv√©e',
        content: `
            <p>Le train magique s'arr√™te devant les portes majestueuses de l'<strong>√âcole des Sortil√®ges</strong>. Votre c≈ìur bat la chamade.</p>
            <p>Les tours du ch√¢teau s'√©l√®vent dans le ciel √©toil√©, illumin√©es par des milliers de bougies flottantes.</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üßì Professeur Grimwald</div>
                <div class="dialogue-text">"Bienvenue, jeunes sorciers ! Je suis le directeur adjoint. Des √©v√©nements √©tranges se sont produits r√©cemment... mais suivez-moi vers la Grande Salle."</div>
            </div>
        `,
        choices: [
            { text: 'üó£Ô∏è "Quels √©v√©nements √©tranges ?"', next: 'question', flag: 'curious' },
            { text: 'üö∂ Suivre silencieusement', next: 'follow' },
            { text: 'üëÄ Observer les alentours', next: 'observe', xp: 10 }
        ]
    },
    question: {
        content: `
            <div class="dialogue-box">
                <div class="dialogue-speaker">üßì Professeur Grimwald</div>
                <div class="dialogue-text">"Le Choixpeau Magique a disparu il y a trois jours. Et ce n'est pas le seul objet manquant... Mais chut, pas un mot aux autres !"</div>
            </div>
            <p><em>Vous avez obtenu une information secr√®te !</em></p>
        `,
        choices: [
            { text: 'ü§î "Je pourrais aider √† enqu√™ter ?"', next: 'offer_help', flag: 'helper' },
            { text: 'ü§ê Garder le secret', next: 'great_hall' }
        ],
        xp: 15
    },
    follow: {
        content: `
            <p>Vous suivez le groupe. Un tableau repr√©sentant un vieux sorcier vous fait signe.</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üñºÔ∏è Portrait de Merlin l'Ancien</div>
                <div class="dialogue-text">"Psst ! Nouveau ! J'ai quelque chose d'important √† te dire..."</div>
            </div>
        `,
        choices: [
            { text: 'üñºÔ∏è S\'approcher du tableau', next: 'painting', xp: 20 },
            { text: 'üö∂ Continuer vers la Grande Salle', next: 'great_hall' }
        ]
    },
    observe: {
        content: `
            <p>Votre regard remarque des d√©tails troublants :</p>
            <ul style="margin: 15px 0 15px 30px;">
                <li>Des marques de griffures sur une colonne</li>
                <li>Une tra√Æn√©e brillante vers les cachots</li>
                <li>Un morceau de tissu noir accroch√©</li>
            </ul>
            <p><em>Votre sens de l'observation vous sera utile !</em></p>
        `,
        choices: [
            { text: 'üîç Examiner la substance brillante', next: 'examine', flag: 'detective' },
            { text: 'üßµ Ramasser le tissu', next: 'great_hall', item: 'cloth' },
            { text: 'üìù M√©moriser pour plus tard', next: 'great_hall' }
        ]
    },
    offer_help: {
        content: `
            <div class="dialogue-box">
                <div class="dialogue-speaker">üßì Professeur Grimwald</div>
                <div class="dialogue-text">"Ha ! L'enthousiasme de la jeunesse ! Peut-√™tre... Retrouvez-moi demain √† mon bureau. Pour l'instant, direction la Grande Salle !"</div>
            </div>
        `,
        choices: [{ text: '‚û°Ô∏è Aller √† la Grande Salle', next: 'great_hall' }],
        flag: 'ally_grimwald'
    },
    painting: {
        content: `
            <div class="dialogue-box">
                <div class="dialogue-speaker">üñºÔ∏è Portrait de Merlin</div>
                <div class="dialogue-text">"Une ombre mal√©fique r√¥de dans cette √©cole. J'ai vu une silhouette encapuchonn√©e entrer dans la biblioth√®que interdite... Prends ce sort, il te sera utile."</div>
            </div>
            <p><em>Vous avez appris le sort "Revelium" ! Il r√©v√®le ce qui est cach√©.</em></p>
        `,
        choices: [
            { text: 'üôè Remercier et partir', next: 'great_hall' },
            { text: '‚ùì "Qui √©tait cette silhouette ?"', next: 'more_info' }
        ],
        spell: { id: 'revelium', name: 'Revelium', icon: 'üëÅÔ∏è', cost: 10, damage: 0, desc: 'R√©v√®le les secrets' }
    },
    examine: {
        content: `
            <p>La substance est visqueuse et brille d'une lueur verd√¢tre. C'est de l'<strong>ectoplasme</strong> - la trace d'une cr√©ature spectrale !</p>
            <p>La piste m√®ne vers les cachots...</p>
        `,
        choices: [
            { text: 'üïØÔ∏è Suivre la piste vers les cachots', next: 'dungeons_entrance', combat: 'ghost' },
            { text: 'üèõÔ∏è Aller d\'abord √† la Grande Salle', next: 'great_hall' }
        ],
        flag: 'knows_ghost'
    },
    more_info: {
        content: `
            <div class="dialogue-box">
                <div class="dialogue-speaker">üñºÔ∏è Portrait de Merlin</div>
                <div class="dialogue-text">"Sa d√©marche m'√©tait famili√®re... Comme quelqu'un de l'√©cole. Attention, ne fais confiance √† personne !"</div>
            </div>
            <p>Des pas approchent dans le couloir...</p>
        `,
        choices: [
            { text: 'üèÉ Fuir rapidement', next: 'great_hall' },
            { text: 'ü´• Se cacher et observer', next: 'spy', xp: 25 }
        ]
    },
    spy: {
        content: `
            <p>Vous vous cachez derri√®re une armure. Le <strong>Professeur Malachar</strong>, ma√Ætre des potions, passe avec un objet brillant en main...</p>
            <p>Il se dirige vers les cachots en marmonnant des paroles incompr√©hensibles.</p>
            <p><em>Le Professeur Malachar est maintenant un suspect !</em></p>
        `,
        choices: [
            { text: 'üîé Le suivre discr√®tement', next: 'follow_malachar', combat: 'goblin' },
            { text: 'üèõÔ∏è Aller √† la Grande Salle', next: 'great_hall' }
        ],
        flag: 'suspect_malachar'
    },
    follow_malachar: {
        content: `
            <p>Vous suivez le professeur dans les couloirs sombres. Soudain, il dispara√Æt derri√®re une porte secr√®te !</p>
            <p>Avant que vous puissiez r√©agir, un <strong>Gobelin</strong> surgit de l'ombre !</p>
        `,
        choices: [
            { text: '‚öîÔ∏è Se pr√©parer au combat !', next: 'after_goblin_fight', combat: 'goblin' }
        ]
    },
    after_goblin_fight: {
        content: `
            <p>Le gobelin vaincu, vous examinez la porte secr√®te. Elle est verrouill√©e par magie.</p>
            <p>Vous entendez des voix √† l'int√©rieur mais impossible d'entrer pour l'instant...</p>
            <p><em>Il vous faudra trouver un moyen d'ouvrir cette porte.</em></p>
        `,
        choices: [
            { text: 'üèõÔ∏è Retourner √† la Grande Salle', next: 'great_hall' }
        ],
        flag: 'found_secret_door',
        unlockLocation: 'dungeons'
    },
    great_hall: {
        title: 'La Grande Salle',
        content: `
            <p>Vous entrez dans la <strong>Grande Salle</strong>. Le plafond enchant√© refl√®te un ciel √©toil√©. Des centaines de bougies flottent dans les airs.</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üë©‚Äçüè´ Directrice √âtoilemer</div>
                <div class="dialogue-text">"Bienvenue √† l'√âcole des Sortil√®ges ! Cette ann√©e sera particuli√®re. En raison de circonstances exceptionnelles, vous avez √©t√© r√©partis √† l'avance."</div>
            </div>
            <p>Vous √™tes dans la maison <strong class="house-name-display"></strong> !</p>
            <p>Apr√®s le festin, un pr√©fet vous guide vers votre salle commune.</p>
        `,
        choices: [
            { text: 'üõèÔ∏è Aller au dortoir', next: 'dormitory', completeQuest: 'q1' },
            { text: 'üîç Explorer avant le couvre-feu', next: 'explore_night' },
            { text: 'üí¨ Parler aux autres √©l√®ves', next: 'talk_students' }
        ]
    },
    talk_students: {
        content: `
            <p>Vous vous asseyez √† la table de votre maison. Une √©l√®ve aux cheveux roux vous aborde.</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üëß √âlise Flamberge</div>
                <div class="dialogue-text">"Salut ! Moi c'est √âlise. Tu as entendu les rumeurs ? Il para√Æt qu'un √©l√®ve a disparu l'ann√©e derni√®re dans la biblioth√®que interdite... et qu'on entend encore ses pas la nuit !"</div>
            </div>
        `,
        choices: [
            { text: 'üò∞ "C\'est effrayant..."', next: 'elise_scared' },
            { text: 'ü§î "Tu y crois vraiment ?"', next: 'elise_skeptic' },
            { text: 'üí™ "J\'irai voir par moi-m√™me !"', next: 'elise_brave', flag: 'brave' }
        ],
        xp: 10
    },
    elise_scared: {
        content: `
            <div class="dialogue-box">
                <div class="dialogue-speaker">üëß √âlise Flamberge</div>
                <div class="dialogue-text">"N'est-ce pas ? Moi je n'irais jamais l√†-bas ! Mais si tu veux enqu√™ter, je peux te donner √ßa..."</div>
            </div>
            <p>Elle vous glisse discr√®tement une <strong>Carte des Passages Secrets</strong> !</p>
        `,
        choices: [
            { text: 'üôè Remercier √âlise', next: 'dormitory' }
        ],
        item: { id: 'secret_map', name: 'Carte des Passages', icon: 'üó∫Ô∏è', count: 1 },
        flag: 'friend_elise'
    },
    elise_skeptic: {
        content: `
            <div class="dialogue-box">
                <div class="dialogue-speaker">üëß √âlise Flamberge</div>
                <div class="dialogue-text">"Hmm, un esprit rationnel ! Mais j'ai vu des choses √©tranges de mes propres yeux. La semaine derni√®re, une ombre est pass√©e devant ma fen√™tre... au cinqui√®me √©tage !"</div>
            </div>
        `,
        choices: [
            { text: 'üîç "Raconte-moi tout"', next: 'elise_details', xp: 15 },
            { text: 'üõèÔ∏è "Int√©ressant. Bonne nuit !"', next: 'dormitory' }
        ]
    },
    elise_brave: {
        content: `
            <div class="dialogue-box">
                <div class="dialogue-speaker">üëß √âlise Flamberge</div>
                <div class="dialogue-text">"Wow, tu es courageux ! Attends, prends √ßa. C'est une potion de mon invention - elle permet de voir dans le noir pendant une heure."</div>
            </div>
            <p>Vous recevez une <strong>Potion de Vision Nocturne</strong> !</p>
        `,
        choices: [
            { text: 'üôè "Merci, je te raconterai ce que je trouve !"', next: 'dormitory' }
        ],
        item: { id: 'night_vision', name: 'Vision Nocturne', icon: 'üëÅÔ∏è', count: 1 },
        flag: 'friend_elise'
    },
    elise_details: {
        content: `
            <div class="dialogue-box">
                <div class="dialogue-speaker">üëß √âlise Flamberge</div>
                <div class="dialogue-text">"L'ombre avait une forme humaine mais... flottait dans les airs. Elle est entr√©e par la fen√™tre de la Tour d'Astronomie. Et le plus √©trange : elle portait une cape avec le blason de l'√©cole !"</div>
            </div>
            <p><em>Quelqu'un de l'√©cole serait impliqu√© ?</em></p>
        `,
        choices: [
            { text: 'üõèÔ∏è Aller se reposer pour r√©fl√©chir', next: 'dormitory' }
        ],
        flag: 'knows_shadow',
        unlockLocation: 'tower'
    },
    explore_night: {
        content: `
            <p>Vous vous faufilez hors de la Grande Salle. Les couloirs sont sombres et silencieux.</p>
            <p>Vous arrivez √† un croisement :</p>
            <ul style="margin: 15px 0 15px 30px;">
                <li>√Ä gauche : la <strong>Biblioth√®que</strong></li>
                <li>√Ä droite : les <strong>Cachots</strong></li>
                <li>Tout droit : la <strong>Cour int√©rieure</strong></li>
            </ul>
        `,
        choices: [
            { text: 'üìö Aller √† la Biblioth√®que', next: 'library_night' },
            { text: 'üïØÔ∏è Descendre aux Cachots', next: 'dungeons_night', combat: 'ghost' },
            { text: 'üåô Aller dans la Cour', next: 'courtyard' }
        ]
    },
    library_night: {
        content: `
            <p>La biblioth√®que est plong√©e dans l'obscurit√©. Vous entendez des pages qui tournent toutes seules...</p>
            <p>Un livre vole soudainement vers vous !</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üìñ Livre Enchant√©</div>
                <div class="dialogue-text">"Qui ose troubler le silence de la biblioth√®que ?!"</div>
            </div>
        `,
        choices: [
            { text: 'üìñ "Je cherche des informations"', next: 'library_info' },
            { text: 'üèÉ Fuir !', next: 'dormitory' },
            { text: '‚ú® Utiliser un sort', next: 'library_spell', requireSpell: 'lumos' }
        ]
    },
    library_info: {
        content: `
            <div class="dialogue-box">
                <div class="dialogue-speaker">üìñ Livre Enchant√©</div>
                <div class="dialogue-text">"Hmm... Un chercheur de v√©rit√©. Tr√®s bien. La Section Interdite cache un secret vieux de 500 ans. Cherche le livre 'Les Ombres de Minuit' - mais attention √† son gardien !"</div>
            </div>
        `,
        choices: [
            { text: 'üìö "O√π est la Section Interdite ?"', next: 'forbidden_location' },
            { text: 'üôè Remercier et partir', next: 'dormitory' }
        ],
        xp: 20,
        flag: 'knows_book'
    },
    library_spell: {
        content: `
            <p>Vous lancez <strong>Lumos</strong> ! Une lumi√®re dor√©e illumine la biblioth√®que.</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üìñ Livre Enchant√©</div>
                <div class="dialogue-text">"Oh ! Un sorcier comp√©tent ! Je vais t'aider. Prends ce parchemin - il contient l'emplacement d'un tr√©sor cach√© dans l'√©cole."</div>
            </div>
            <p>Vous recevez un <strong>Parchemin au Tr√©sor</strong> !</p>
        `,
        choices: [
            { text: 'üôè Remercier et explorer', next: 'forbidden_location' }
        ],
        item: { id: 'treasure_map', name: 'Parchemin au Tr√©sor', icon: 'üìú', count: 1 },
        xp: 30
    },
    forbidden_location: {
        content: `
            <p>Le livre vous guide vers une section cach√©e derri√®re une √©tag√®re. Un couloir sombre m√®ne √† la <strong>Section Interdite</strong>.</p>
            <p>Une aura mal√©fique √©mane de l'entr√©e...</p>
        `,
        choices: [
            { text: '‚ö†Ô∏è Entrer dans la Section Interdite', next: 'forbidden_enter', combat: 'dark_wizard' },
            { text: 'üõèÔ∏è Revenir plus tard, mieux pr√©par√©', next: 'dormitory' }
        ],
        unlockLocation: 'forbidden'
    },
    forbidden_enter: {
        content: `
            <p>Vous p√©n√©trez dans la Section Interdite. Des livres g√©missent sur les √©tag√®res.</p>
            <p>Soudain, une silhouette encapuchonn√©e appara√Æt devant vous !</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üßô‚Äç‚ôÇÔ∏è Figure Encapuchonn√©e</div>
                <div class="dialogue-text">"Tu n'aurais pas d√ª venir ici, jeune sorcier. Le secret doit rester enfoui !"</div>
            </div>
        `,
        choices: [
            { text: '‚öîÔ∏è Se d√©fendre !', next: 'after_dark_wizard', combat: 'dark_wizard' }
        ]
    },
    after_dark_wizard: {
        content: `
            <p>Le mage noir s'enfuit dans un nuage de fum√©e noire ! Mais il laisse tomber un objet...</p>
            <p>C'est un <strong>M√©daillon avec le blason de l'√©cole</strong> ! Il porte une inscription : "M.S. - 1823"</p>
            <p><em>Qui est M.S. ? Et quel est le lien avec les √©v√©nements actuels ?</em></p>
        `,
        choices: [
            { text: 'üîç Chercher le livre "Les Ombres de Minuit"', next: 'find_book' },
            { text: 'üèÉ Fuir avant qu\'il ne revienne', next: 'dormitory' }
        ],
        item: { id: 'medallion', name: 'M√©daillon Myst√©rieux', icon: 'üèÖ', count: 1 },
        xp: 50,
        flag: 'has_medallion'
    },
    find_book: {
        title: 'Les Ombres de Minuit',
        content: `
            <p>Vous trouvez le livre ! En l'ouvrant, une voix spectrale s'√©l√®ve...</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üìñ Voix du Livre</div>
                <div class="dialogue-text">"Il y a 200 ans, un √©l√®ve nomm√© Magnus Sombral a tent√© de devenir immortel. Son √¢me a √©t√© pi√©g√©e dans les cachots... et quelqu'un essaie de le lib√©rer !"</div>
            </div>
            <p><em>M.S. = Magnus Sombral ! Le myst√®re s'√©claircit !</em></p>
        `,
        choices: [
            { text: 'üïØÔ∏è Aller aux Cachots imm√©diatement', next: 'dungeons_final' },
            { text: 'üõèÔ∏è Se reposer et se pr√©parer', next: 'dormitory', completeQuest: 'q2' }
        ],
        xp: 75,
        flag: 'knows_magnus',
        activateQuest: 'q3',
        unlockLocation: 'dungeons'
    },
    courtyard: {
        content: `
            <p>La cour int√©rieure est baign√©e par la lumi√®re de la lune. Une fontaine magique brille au centre.</p>
            <p>Vous remarquez une silhouette pr√®s des arbres...</p>
        `,
        choices: [
            { text: 'üó£Ô∏è Approcher et parler', next: 'courtyard_figure' },
            { text: 'ü´• Observer de loin', next: 'courtyard_observe' },
            { text: '‚õ≤ Examiner la fontaine', next: 'fountain' }
        ]
    },
    courtyard_figure: {
        content: `
            <p>C'est le <strong>Professeur Malachar</strong> ! Il sursaute en vous voyant.</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üß™ Professeur Malachar</div>
                <div class="dialogue-text">"Que fais-tu dehors √† cette heure ?! Retourne imm√©diatement √† ton dortoir ! 20 points en moins pour ta maison !"</div>
            </div>
            <p>Il semble nerveux et cache quelque chose dans sa cape...</p>
        `,
        choices: [
            { text: 'üòî Ob√©ir et partir', next: 'dormitory' },
            { text: 'ü§® "Que cachez-vous ?"', next: 'confront_malachar', flag: 'confronted_malachar' }
        ]
    },
    courtyard_observe: {
        content: `
            <p>De votre cachette, vous voyez le Professeur Malachar sortir un objet brillant - c'est le <strong>Choixpeau Magique</strong> !</p>
            <p>Il murmure une incantation et le choixpeau s'illumine bri√®vement avant qu'il ne le cache √† nouveau.</p>
            <p><em>Le Professeur Malachar a vol√© le Choixpeau ! Mais pourquoi ?</em></p>
        `,
        choices: [
            { text: 'üèÉ Courir pr√©venir la directrice', next: 'tell_director' },
            { text: 'üîé Continuer √† observer', next: 'observe_more' }
        ],
        xp: 40,
        flag: 'saw_malachar_choixpeau'
    },
    confront_malachar: {
        content: `
            <div class="dialogue-box">
                <div class="dialogue-speaker">üß™ Professeur Malachar</div>
                <div class="dialogue-text">"Comment oses-tu ?! Tu ne sais pas √† qui tu t'adresses ! Les √©l√®ves curieux ont tendance √†... dispara√Ætre dans cette √©cole."</div>
            </div>
            <p>Ses yeux brillent d'une lueur mena√ßante. Vous sentez le danger...</p>
        `,
        choices: [
            { text: 'üèÉ Fuir !', next: 'dormitory' },
            { text: 'üí™ "Vous ne me faites pas peur !"', next: 'malachar_fight', combat: 'dark_wizard' }
        ]
    },
    malachar_fight: {
        content: `
            <p>Le professeur l√®ve sa baguette mais h√©site... puis baisse le bras.</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üß™ Professeur Malachar</div>
                <div class="dialogue-text">"Tu as du courage, petit. Peut-√™tre trop. Sache que tout n'est pas ce qu'il semble √™tre. Certains d'entre nous essaient de PROT√âGER l'√©cole, pas de lui nuire. Maintenant, va-t'en !"</div>
            </div>
            <p><em>Le professeur est-il vraiment un ennemi ?</em></p>
        `,
        choices: [
            { text: 'ü§î R√©fl√©chir en retournant au dortoir', next: 'dormitory' }
        ],
        xp: 35,
        flag: 'malachar_ambiguous'
    },
    observe_more: {
        content: `
            <p>Malachar se dirige vers les cachots. Un autre personnage l'attend dans l'ombre - impossible de voir qui c'est.</p>
            <p>Vous entendez : "Le rituel doit avoir lieu √† minuit. Tout est pr√™t ?"</p>
            <p>Malachar r√©pond : "Oui, mais je doute encore... Est-ce vraiment la seule solution ?"</p>
        `,
        choices: [
            { text: 'üïØÔ∏è Les suivre aux cachots', next: 'dungeons_night', combat: 'ghost' },
            { text: 'üõèÔ∏è Revenir mieux pr√©par√©', next: 'dormitory' }
        ],
        xp: 50,
        flag: 'overheard_ritual'
    },
    tell_director: {
        content: `
            <p>Vous courez vers le bureau de la directrice. Elle vous re√ßoit malgr√© l'heure tardive.</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üë©‚Äçüè´ Directrice √âtoilemer</div>
                <div class="dialogue-text">"Le Professeur Malachar ? C'est une accusation grave... mais pas surprenante. Je le surveille depuis des semaines. Merci pour ces informations. Retourne te coucher, je m'en occupe."</div>
            </div>
        `,
        choices: [
            { text: 'üõèÔ∏è Ob√©ir et aller dormir', next: 'dormitory', xp: 30 },
            { text: 'üí™ "Je veux aider !"', next: 'help_director' }
        ]
    },
    help_director: {
        content: `
            <div class="dialogue-box">
                <div class="dialogue-speaker">üë©‚Äçüè´ Directrice √âtoilemer</div>
                <div class="dialogue-text">"Hmm... Tu as du cran. Tr√®s bien. Prends ceci - c'est un badge sp√©cial qui te permet d'acc√©der √† toutes les zones de l'√©cole. Mais sois prudent !"</div>
            </div>
            <p>Vous recevez un <strong>Badge d'Acc√®s Sp√©cial</strong> !</p>
        `,
        choices: [
            { text: 'üôè Remercier et commencer l\'enqu√™te', next: 'dormitory' }
        ],
        item: { id: 'access_badge', name: 'Badge d\'Acc√®s', icon: 'üé´', count: 1 },
        xp: 50,
        flag: 'ally_director',
        unlockAllLocations: true
    },
    fountain: {
        content: `
            <p>La fontaine magique brille d'une lueur argent√©e. En vous penchant, vous voyez des visions dans l'eau...</p>
            <p>Vous apercevez : un m√©daillon, une silhouette dans les cachots, et... votre propre visage, plus √¢g√©, tenant une baguette puissante.</p>
            <p><em>Une proph√©tie ? Un avertissement ?</em></p>
        `,
        choices: [
            { text: 'üí∞ Jeter une pi√®ce et faire un v≈ìu', next: 'fountain_wish' },
            { text: 'üîç Examiner la base de la fontaine', next: 'fountain_base' },
            { text: 'üö∂ Partir', next: 'dormitory' }
        ],
        xp: 15
    },
    fountain_wish: {
        content: `
            <p>Vous jetez une pi√®ce d'or. La fontaine s'illumine et une voix r√©sonne :</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">‚õ≤ Esprit de la Fontaine</div>
                <div class="dialogue-text">"Ton souhait est noble, jeune sorcier. Accepte ce don pour t'aider dans ta qu√™te."</div>
            </div>
            <p>Votre mana maximum augmente de 20 !</p>
        `,
        choices: [
            { text: '‚ú® Continuer', next: 'dormitory' }
        ],
        effect: { maxMana: 20 },
        goldCost: 1
    },
    fountain_base: {
        content: `
            <p>√Ä la base de la fontaine, vous trouvez une inscription ancienne et... un compartiment secret !</p>
            <p>√Ä l'int√©rieur : une <strong>Baguette Ancienne</strong> d'une puissance incroyable !</p>
        `,
        choices: [
            { text: 'ü™Ñ Prendre la baguette', next: 'dormitory' }
        ],
        item: { id: 'ancient_wand', name: 'Baguette Ancienne', icon: 'ü™Ñ', count: 1 },
        effect: { attack: 10 },
        xp: 40
    },
    dungeons_night: {
        content: `
            <p>Les cachots sont froids et humides. Des torches vacillent sur les murs.</p>
            <p>Un g√©missement r√©sonne dans les t√©n√®bres... Un <strong>Fant√¥me Furieux</strong> appara√Æt !</p>
        `,
        choices: [
            { text: '‚öîÔ∏è Combattre !', next: 'dungeons_explore', combat: 'ghost' }
        ]
    },
    dungeons_explore: {
        content: `
            <p>Le fant√¥me vaincu, vous explorez les cachots. Vous trouvez :</p>
            <ul style="margin: 15px 0 15px 30px;">
                <li>Une cellule avec des marques de griffes</li>
                <li>Un autel ancien avec des bougies noires</li>
                <li>Une porte scell√©e par magie</li>
            </ul>
        `,
        choices: [
            { text: 'üîç Examiner l\'autel', next: 'examine_altar' },
            { text: 'üö™ Tenter d\'ouvrir la porte', next: 'sealed_door' },
            { text: 'üèÉ Remonter', next: 'dormitory' }
        ],
        xp: 25
    },
    examine_altar: {
        content: `
            <p>L'autel porte des symboles de magie noire. Un livre est ouvert sur une page intitul√©e "Rituel de Lib√©ration".</p>
            <p>Le rituel permet de lib√©rer une √¢me pi√©g√©e... mais n√©cessite un sacrifice !</p>
            <p><em>Quelqu'un pr√©pare ce rituel !</em></p>
        `,
        choices: [
            { text: 'üìñ Prendre le livre', next: 'take_book' },
            { text: 'üö™ Examiner la porte scell√©e', next: 'sealed_door' }
        ],
        xp: 30,
        flag: 'knows_ritual'
    },
    take_book: {
        content: `
            <p>En prenant le livre, une alarme magique se d√©clenche ! Des pas approchent...</p>
            <p>Vous devez fuir rapidement !</p>
        `,
        choices: [
            { text: 'üèÉ Fuir par le passage secret', next: 'secret_passage' },
            { text: 'ü´• Se cacher', next: 'hide_dungeons' }
        ],
        item: { id: 'dark_book', name: 'Livre de Rituels', icon: 'üìï', count: 1 }
    },
    secret_passage: {
        content: `
            <p>Vous trouvez un passage secret derri√®re une tapisserie ! Il m√®ne directement √† votre dortoir.</p>
            <p><em>Ce passage pourra √™tre utile √† l'avenir !</em></p>
        `,
        choices: [
            { text: 'üõèÔ∏è Se reposer enfin', next: 'dormitory' }
        ],
        xp: 20,
        flag: 'knows_passage'
    },
    hide_dungeons: {
        content: `
            <p>Vous vous cachez dans l'ombre. Le Professeur Malachar entre avec la directrice !</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üë©‚Äçüè´ Directrice √âtoilemer</div>
                <div class="dialogue-text">"L'alarme s'est d√©clench√©e. Quelqu'un sait pour le rituel."</div>
            </div>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üß™ Professeur Malachar</div>
                <div class="dialogue-text">"Nous devons acc√©l√©rer. Si Magnus Sombral est lib√©r√© par quelqu'un d'autre, l'√©cole sera d√©truite !"</div>
            </div>
            <p><em>Ils essaient d'EMP√äCHER le rituel, pas de l'accomplir !</em></p>
        `,
        choices: [
            { text: 'üó£Ô∏è Sortir de ma cachette', next: 'reveal_yourself' },
            { text: 'ü§´ Rester cach√© et √©couter', next: 'keep_listening' }
        ],
        xp: 50,
        flag: 'truth_revealed'
    },
    reveal_yourself: {
        content: `
            <p>Vous sortez de l'ombre. Les deux professeurs sursautent.</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üë©‚Äçüè´ Directrice √âtoilemer</div>
                <div class="dialogue-text">"Toi ! Tu nous as suivis ? ... Non, peu importe. Tu en sais trop maintenant. Tu vas devoir nous aider."</div>
            </div>
            <p>La directrice vous explique tout : un ancien √©l√®ve mal√©fique tente de revenir, et seul un jeune sorcier au c≈ìur pur peut l'arr√™ter.</p>
        `,
        choices: [
            { text: 'üí™ "Je suis pr√™t √† aider !"', next: 'final_quest' }
        ],
        xp: 75,
        flag: 'joined_teachers',
        activateQuest: 'q3'
    },
    keep_listening: {
        content: `
            <p>Les professeurs continuent :</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üß™ Professeur Malachar</div>
                <div class="dialogue-text">"Le vrai coupable est dans l'√©cole. J'ai des soup√ßons sur le professeur de D√©fense..."</div>
            </div>
            <p>Ils partent sans vous remarquer. Vous avez des informations cruciales !</p>
        `,
        choices: [
            { text: 'üõèÔ∏è Retourner au dortoir', next: 'dormitory' }
        ],
        xp: 60,
        flag: 'suspect_defense_prof'
    },
    sealed_door: {
        content: `
            <p>La porte est scell√©e par de puissants enchantements. Une inscription dit :</p>
            <p><em>"Seul celui qui porte le m√©daillon du fondateur peut entrer."</em></p>
        `,
        choices: [
            { text: 'üèÖ Utiliser le m√©daillon', next: 'open_door', requireItem: 'medallion' },
            { text: 'üîô Revenir plus tard', next: 'dormitory' }
        ]
    },
    open_door: {
        content: `
            <p>Le m√©daillon s'illumine et la porte s'ouvre lentement...</p>
            <p>√Ä l'int√©rieur, une salle circulaire avec un cercle de runes au sol. Au centre, une forme spectrale est encha√Æn√©e !</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üë§ Magnus Sombral</div>
                <div class="dialogue-text">"Enfin ! Un visiteur ! Lib√®re-moi et je te donnerai un pouvoir immense !"</div>
            </div>
        `,
        choices: [
            { text: '‚õìÔ∏è "Jamais ! Tu resteras prisonnier !"', next: 'refuse_magnus' },
            { text: 'ü§î "Pourquoi es-tu enferm√© ?"', next: 'ask_magnus' },
            { text: 'üòà "Quel pouvoir ?"', next: 'tempted', flag: 'tempted_by_evil' }
        ],
        xp: 50
    },
    refuse_magnus: {
        content: `
            <div class="dialogue-box">
                <div class="dialogue-speaker">üë§ Magnus Sombral</div>
                <div class="dialogue-text">"Petit imb√©cile ! Mes serviteurs me lib√©reront de toute fa√ßon ! Et quand je serai libre, tu seras le premier √† p√©rir !"</div>
            </div>
            <p>La forme spectrale hurle de rage. Vous devez fuir !</p>
        `,
        choices: [
            { text: 'üèÉ Fuir et pr√©venir les professeurs', next: 'final_quest' }
        ],
        xp: 40,
        flag: 'refused_magnus'
    },
    ask_magnus: {
        content: `
            <div class="dialogue-box">
                <div class="dialogue-speaker">üë§ Magnus Sombral</div>
                <div class="dialogue-text">"Les fondateurs m'ont trahi ! Je voulais simplement repousser les limites de la magie... L'immortalit√© n'est pas un crime ! Ils m'ont enferm√© par jalousie !"</div>
            </div>
            <p>Ses yeux brillent de folie. Vous sentez qu'il ment...</p>
        `,
        choices: [
            { text: '‚õìÔ∏è "Tu resteras ici."', next: 'refuse_magnus' },
            { text: 'üèÉ Partir sans r√©pondre', next: 'final_quest' }
        ]
    },
    tempted: {
        content: `
            <div class="dialogue-box">
                <div class="dialogue-speaker">üë§ Magnus Sombral</div>
                <div class="dialogue-text">"Ahhh, je sens l'ambition en toi ! Lib√®re-moi et tu deviendras le plus grand sorcier de tous les temps ! Ensemble, nous dominerons le monde magique !"</div>
            </div>
            <p>Une √©nergie sombre vous enveloppe... Vous sentez votre volont√© faiblir...</p>
        `,
        choices: [
            { text: 'üí™ R√©sister √† la tentation !', next: 'resist_temptation' },
            { text: 'üòà Accepter le pouvoir...', next: 'dark_ending' }
        ]
    },
    resist_temptation: {
        content: `
            <p>Vous puisez dans votre courage et repoussez l'influence mal√©fique !</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üë§ Magnus Sombral</div>
                <div class="dialogue-text">"NON ! Tu le regretteras !"</div>
            </div>
            <p><em>Votre r√©sistance vous a rendu plus fort ! +20 PV max !</em></p>
        `,
        choices: [
            { text: 'üèÉ Fuir et pr√©parer la bataille finale', next: 'final_quest' }
        ],
        xp: 100,
        effect: { maxHealth: 20 },
        flag: 'resisted_evil'
    },
    dark_ending: {
        title: 'FIN - Le Sorcier Corrompu',
        content: `
            <p style="color: #ff4444;">Vous acceptez le pouvoir de Magnus Sombral...</p>
            <p>Une √©nergie noire vous envahit. Vos yeux deviennent rouges comme le sang.</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üë§ Magnus Sombral</div>
                <div class="dialogue-text">"Excellent ! Maintenant, brise mes cha√Ænes !"</div>
            </div>
            <p>Vous lib√©rez l'esprit mal√©fique. Ensemble, vous d√©truisez l'√©cole et plongez le monde magique dans les t√©n√®bres...</p>
            <p style="color: #ff4444; font-size: 1.3em; text-align: center; margin-top: 30px;">‚ö∞Ô∏è MAUVAISE FIN ‚ö∞Ô∏è</p>
            <p style="text-align: center;"><em>Recommencez pour d√©couvrir la vraie fin !</em></p>
        `,
        choices: [
            { text: 'üîÑ Recommencer', next: 'intro', reset: true }
        ]
    },
    dormitory: {
        title: 'Le Dortoir',
        content: `
            <p>Vous arrivez dans votre dortoir. Le lit est confortable et des rideaux magiques vous offrent l'intimit√©.</p>
            <p>Vos d√©couvertes de la journ√©e tournent dans votre t√™te...</p>
            <p><em>Votre sant√© et votre mana sont restaur√©s !</em></p>
        `,
        choices: [
            { text: 'üò¥ Dormir et passer au lendemain', next: 'next_day' },
            { text: 'üìñ √âtudier vos sorts', next: 'study_spells' },
            { text: 'üó∫Ô∏è Consulter la carte', next: 'check_map' }
        ],
        effect: { fullRestore: true }
    },
    study_spells: {
        content: `
            <p>Vous passez la soir√©e √† pratiquer vos sorts. Votre magie s'am√©liore !</p>
            <p><em>+5 d√©g√¢ts magiques !</em></p>
        `,
        choices: [
            { text: 'üò¥ Dormir', next: 'next_day' }
        ],
        xp: 20,
        effect: { attack: 5 }
    },
    check_map: {
        content: `
            <p>Vous consultez vos informations sur l'√©cole :</p>
            <ul style="margin: 15px 0 15px 30px;">
                <li><strong>Biblioth√®que</strong> - Source d'informations</li>
                <li><strong>Cachots</strong> - Lieu du myst√®re principal</li>
                <li><strong>Tour d'Astronomie</strong> - Vue sur toute l'√©cole</li>
                <li><strong>For√™t Interdite</strong> - Dangereuse mais pleine de secrets</li>
            </ul>
        `,
        choices: [
            { text: 'üò¥ Dormir', next: 'next_day' }
        ]
    },
    next_day: {
        title: 'Un Nouveau Jour',
        content: `
            <p>Le soleil entre par la fen√™tre. Une nouvelle journ√©e commence √† l'√âcole des Sortil√®ges.</p>
            <p>Que souhaitez-vous faire aujourd'hui ?</p>
        `,
        choices: [
            { text: 'üìö Aller en cours', next: 'classes' },
            { text: 'üîç Continuer l\'enqu√™te', next: 'continue_investigation' },
            { text: 'üó∫Ô∏è Explorer un nouveau lieu', next: 'explore_choice' }
        ]
    },
    classes: {
        content: `
            <p>Vous assistez au cours de <strong>D√©fense contre les Forces du Mal</strong>.</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üßô Professeur Darkwood</div>
                <div class="dialogue-text">"Aujourd'hui, nous allons apprendre √† nous d√©fendre contre les esprits malveillants. Qui veut faire une d√©monstration ?"</div>
            </div>
        `,
        choices: [
            { text: 'üôã Se porter volontaire', next: 'volunteer', xp: 25 },
            { text: 'ü§´ Rester discret', next: 'stay_quiet_class' }
        ]
    },
    volunteer: {
        content: `
            <p>Vous vous levez courageusement. Le professeur vous fait face √† un √©pouvantard !</p>
            <p>La cr√©ature prend la forme de vos pires peurs... mais vous la repoussez avec brio !</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üßô Professeur Darkwood</div>
                <div class="dialogue-text">"Excellent ! 30 points pour votre maison ! Vous avez un talent naturel."</div>
            </div>
            <p><em>Vous avez appris le sort "Riddikulus" !</em></p>
        `,
        choices: [
            { text: '‚ú® Continuer la journ√©e', next: 'after_class' }
        ],
        xp: 40,
        spell: { id: 'riddikulus', name: 'Riddikulus', icon: 'üòÇ', cost: 15, damage: 20, desc: 'Transforme les peurs en rire' }
    },
    stay_quiet_class: {
        content: `
            <p>Un autre √©l√®ve se porte volontaire mais √©choue. Le professeur semble d√©√ßu.</p>
            <p>Pendant ce temps, vous remarquez que le professeur Darkwood porte un m√©daillon similaire √† celui que vous avez trouv√©...</p>
        `,
        choices: [
            { text: 'üîç Observer le m√©daillon de plus pr√®s', next: 'observe_darkwood' },
            { text: 'üìù Prendre des notes normalement', next: 'after_class' }
        ],
        flag: 'noticed_darkwood'
    },
    observe_darkwood: {
        content: `
            <p>En regardant attentivement, vous voyez que le m√©daillon du professeur porte les initiales "M.S." !</p>
            <p><em>Le m√™me que celui de Magnus Sombral ! Le professeur Darkwood serait-il impliqu√© ?</em></p>
        `,
        choices: [
            { text: '‚ö†Ô∏è Le confronter apr√®s le cours', next: 'confront_darkwood' },
            { text: 'ü§´ Garder cette information', next: 'after_class' }
        ],
        xp: 35,
        flag: 'suspect_darkwood'
    },
    confront_darkwood: {
        content: `
            <p>Apr√®s le cours, vous approchez le professeur.</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">Vous</div>
                <div class="dialogue-text">"Professeur, votre m√©daillon... Il porte les initiales M.S., n'est-ce pas ?"</div>
            </div>
            <p>Le professeur p√¢lit soudainement...</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üßô Professeur Darkwood</div>
                <div class="dialogue-text">"Comment sais-tu... ? Suis-moi. Il est temps que quelqu'un sache la v√©rit√©."</div>
            </div>
        `,
        choices: [
            { text: 'üö∂ Le suivre', next: 'darkwood_truth' }
        ]
    },
    darkwood_truth: {
        content: `
            <p>Dans son bureau, le professeur vous r√©v√®le tout :</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üßô Professeur Darkwood</div>
                <div class="dialogue-text">"Magnus Sombral √©tait mon anc√™tre. Sa mal√©diction p√®se sur ma famille depuis des g√©n√©rations. J'essaie de l'emp√™cher de revenir, mais quelqu'un dans cette √©cole tente de le lib√©rer ! Aide-moi √† l'arr√™ter !"</div>
            </div>
        `,
        choices: [
            { text: 'ü§ù "Je vous aiderai !"', next: 'ally_darkwood' },
            { text: 'ü§î "Comment puis-je vous faire confiance ?"', next: 'trust_test' }
        ],
        xp: 50
    },
    ally_darkwood: {
        content: `
            <p>Le professeur vous donne une <strong>Amulette de Protection</strong>.</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üßô Professeur Darkwood</div>
                <div class="dialogue-text">"Porte ceci. Elle te prot√©gera de l'influence de Magnus. Le rituel aura lieu ce soir √† minuit dans les cachots. Nous devons l'arr√™ter !"</div>
            </div>
        `,
        choices: [
            { text: '‚öîÔ∏è Se pr√©parer pour ce soir', next: 'final_quest' }
        ],
        item: { id: 'protection_amulet', name: 'Amulette de Protection', icon: 'üìø', count: 1 },
        effect: { defense: 10 },
        flag: 'ally_darkwood'
    },
    trust_test: {
        content: `
            <div class="dialogue-box">
                <div class="dialogue-speaker">üßô Professeur Darkwood</div>
                <div class="dialogue-text">"Ta m√©fiance est sage. Tiens, prends ce parchemin. Il contient mes recherches sur Magnus. Lis-les et d√©cide par toi-m√™me."</div>
            </div>
            <p>Apr√®s lecture, tout semble coh√©rent. Le professeur dit la v√©rit√©.</p>
        `,
        choices: [
            { text: 'ü§ù "D\'accord, je vous crois"', next: 'ally_darkwood' }
        ],
        xp: 30
    },
    after_class: {
        content: `
            <p>Les cours sont termin√©s pour aujourd'hui. Que souhaitez-vous faire ?</p>
        `,
        choices: [
            { text: 'üîç Continuer l\'enqu√™te', next: 'continue_investigation' },
            { text: 'üõèÔ∏è Retourner au dortoir', next: 'dormitory' },
            { text: 'üó∫Ô∏è Explorer un lieu', next: 'explore_choice' }
        ]
    },
    continue_investigation: {
        content: `
            <p>Vous r√©fl√©chissez aux indices que vous avez collect√©s...</p>
            <p>Tout pointe vers les cachots et un rituel imminent. Il est temps d'agir !</p>
        `,
        choices: [
            { text: 'üïØÔ∏è Aller aux cachots', next: 'final_quest' },
            { text: 'üìö Chercher plus d\'infos √† la biblioth√®que', next: 'library_research' },
            { text: 'üó£Ô∏è Parler aux professeurs', next: 'talk_professors' }
        ]
    },
    explore_choice: {
        content: `
            <p>O√π souhaitez-vous aller ?</p>
        `,
        choices: [
            { text: 'üìö Biblioth√®que', next: 'library_day' },
            { text: 'üî≠ Tour d\'Astronomie', next: 'tower_visit' },
            { text: 'üå≤ For√™t Interdite', next: 'forest_entrance', combat: 'spider' },
            { text: 'üïØÔ∏è Cachots', next: 'dungeons_day' }
        ]
    },
    library_day: {
        content: `
            <p>La biblioth√®que est calme pendant la journ√©e. La biblioth√©caire, Madame Plume, vous accueille.</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üìö Madame Plume</div>
                <div class="dialogue-text">"Bonjour jeune sorcier ! Que recherches-tu aujourd'hui ? Nous avons des ouvrages sur tous les sujets... sauf la Section Interdite, bien s√ªr."</div>
            </div>
        `,
        choices: [
            { text: 'üìñ "Je cherche des infos sur Magnus Sombral"', next: 'library_magnus' },
            { text: '‚ú® "Des livres sur les sorts avanc√©s"', next: 'library_spells' },
            { text: 'üó∫Ô∏è "L\'histoire de l\'√©cole"', next: 'library_history' }
        ]
    },
    library_magnus: {
        content: `
            <p>Madame Plume p√¢lit √† ce nom.</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üìö Madame Plume</div>
                <div class="dialogue-text">"Magnus Sombral ? Pourquoi un √©l√®ve s'int√©resserait-il √† ce... monstre ? Il a failli d√©truire l'√©cole il y a 200 ans !"</div>
            </div>
            <p>Elle vous conduit vers une section poussi√©reuse.</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üìö Madame Plume</div>
                <div class="dialogue-text">"Ce livre contient tout ce qu'on sait sur lui. Mais sois prudent... certaines connaissances sont dangereuses."</div>
            </div>
        `,
        choices: [
            { text: 'üìñ Lire le livre', next: 'read_magnus_book' }
        ],
        xp: 20
    },
    read_magnus_book: {
        content: `
            <p>Vous apprenez l'histoire compl√®te de <strong>Magnus Sombral</strong> :</p>
            <ul style="margin: 15px 0 15px 30px;">
                <li>√âl√®ve brillant mais obs√©d√© par l'immortalit√©</li>
                <li>A cr√©√© un rituel de magie noire</li>
                <li>Son √¢me a √©t√© pi√©g√©e par les fondateurs</li>
                <li>Peut √™tre lib√©r√© uniquement par un descendant... ou par un sacrifice volontaire</li>
            </ul>
            <p><em>Information cruciale : le rituel n√©cessite le Choixpeau Magique !</em></p>
        `,
        choices: [
            { text: 'üò± "Le Choixpeau a √©t√© vol√©..."', next: 'realize_danger' }
        ],
        xp: 40,
        flag: 'full_knowledge'
    },
    realize_danger: {
        content: `
            <p>Tout s'assemble dans votre esprit ! Quelqu'un a vol√© le Choixpeau pour accomplir le rituel !</p>
            <p>Il faut agir vite avant qu'il ne soit trop tard !</p>
        `,
        choices: [
            { text: 'üèÉ Courir pr√©venir la directrice', next: 'warn_director' },
            { text: '‚öîÔ∏è Aller directement aux cachots', next: 'final_quest' }
        ],
        activateQuest: 'q3'
    },
    warn_director: {
        content: `
            <p>Vous trouvez la directrice dans son bureau. Elle √©coute attentivement.</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üë©‚Äçüè´ Directrice √âtoilemer</div>
                <div class="dialogue-text">"Tu as d√©couvert tout cela seul ? Impressionnant ! Nous savions qu'un danger approchait, mais tu as assembl√© les pi√®ces du puzzle. Ce soir, nous devons agir. Tu seras notre atout secret."</div>
            </div>
        `,
        choices: [
            { text: 'üí™ "Je suis pr√™t !"', next: 'final_quest' }
        ],
        xp: 50,
        flag: 'director_ally'
    },
    library_spells: {
        content: `
            <p>Madame Plume vous guide vers la section des sortil√®ges avanc√©s.</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üìö Madame Plume</div>
                <div class="dialogue-text">"Voici nos meilleurs ouvrages. √âtudie bien, jeune sorcier !"</div>
            </div>
            <p>Apr√®s des heures d'√©tude, vous ma√Ætrisez un nouveau sort !</p>
            <p><em>Vous avez appris "Expelliarmus" !</em></p>
        `,
        choices: [
            { text: '‚ú® Continuer', next: 'after_class' }
        ],
        xp: 30,
        spell: { id: 'expelliarmus', name: 'Expelliarmus', icon: 'üåü', cost: 25, damage: 35, desc: 'D√©sarme l\'adversaire' }
    },
    library_history: {
        content: `
            <p>Vous d√©couvrez l'histoire fascinante de l'√©cole :</p>
            <ul style="margin: 15px 0 15px 30px;">
                <li>Fond√©e il y a 1000 ans par quatre grands sorciers</li>
                <li>Chaque fondateur a laiss√© un artefact magique</li>
                <li>Le Choixpeau appartenait au fondateur Aldric Griffeor</li>
                <li>Des passages secrets relient toutes les parties du ch√¢teau</li>
            </ul>
        `,
        choices: [
            { text: 'üó∫Ô∏è Chercher les passages secrets', next: 'find_passages' },
            { text: 'üìñ Continuer √† lire', next: 'after_class' }
        ],
        xp: 25
    },
    find_passages: {
        content: `
            <p>Dans un vieux manuscrit, vous trouvez une carte des passages secrets !</p>
            <p><em>Vous pouvez maintenant acc√©der √† toutes les zones de l'√©cole !</em></p>
        `,
        choices: [
            { text: '‚ú® Excellent !', next: 'after_class' }
        ],
        item: { id: 'passage_map', name: 'Carte des Passages', icon: 'üó∫Ô∏è', count: 1 },
        unlockAllLocations: true,
        xp: 35
    },
    tower_visit: {
        content: `
            <p>Vous grimpez les escaliers en colima√ßon jusqu'√† la <strong>Tour d'Astronomie</strong>.</p>
            <p>La vue est incroyable ! Vous voyez tout le domaine de l'√©cole.</p>
            <p>Quelque chose attire votre attention : une lumi√®re verte clignote pr√®s de la <strong>For√™t Interdite</strong>...</p>
        `,
        choices: [
            { text: 'üî≠ Utiliser le t√©lescope', next: 'use_telescope' },
            { text: 'üå≤ Descendre vers la for√™t', next: 'forest_entrance', combat: 'spider' },
            { text: 'üîô Redescendre', next: 'after_class' }
        ]
    },
    use_telescope: {
        content: `
            <p>√Ä travers le t√©lescope, vous voyez clairement : une silhouette encapuchonn√©e trace des runes autour d'un cercle de pierres dans la for√™t !</p>
            <p>C'est un lieu de rituel ! Et il sera pr√™t... cette nuit !</p>
        `,
        choices: [
            { text: '‚ö†Ô∏è Pr√©venir quelqu\'un', next: 'warn_director' },
            { text: 'üå≤ Aller voir de plus pr√®s', next: 'forest_entrance', combat: 'spider' }
        ],
        xp: 30,
        flag: 'saw_ritual_site'
    },
    forest_entrance: {
        content: `
            <p>L'entr√©e de la <strong>For√™t Interdite</strong> est sombre et mena√ßante. Des bruits √©tranges r√©sonnent entre les arbres.</p>
            <p>Un panneau avertit : "DANGER - Cr√©atures magiques hostiles"</p>
            <p>Soudain, une <strong>Araign√©e G√©ante</strong> descend de sa toile !</p>
        `,
        choices: [
            { text: '‚öîÔ∏è Combattre !', next: 'forest_explore', combat: 'spider' }
        ]
    },
    forest_explore: {
        content: `
            <p>L'araign√©e vaincue, vous avancez dans la for√™t. Vous trouvez le cercle de pierres !</p>
            <p>Des runes sont grav√©es au sol, pr√™tes pour un rituel. Au centre, un pi√©destal attend... le Choixpeau.</p>
            <p><em>C'est ici que tout va se jouer !</em></p>
        `,
        choices: [
            { text: 'üîç Examiner les runes', next: 'examine_runes' },
            { text: 'üí£ Saboter le cercle', next: 'sabotage' },
            { text: 'üèÉ Partir pr√©venir les autres', next: 'warn_director' }
        ],
        xp: 40,
        flag: 'found_ritual_site'
    },
    examine_runes: {
        content: `
            <p>Les runes sont de la magie noire ancienne. Vous reconnaissez certains symboles de vos cours.</p>
            <p>Le rituel doit √™tre accompli √† minuit pile, quand la lune est √† son z√©nith.</p>
            <p>Il reste quelques heures pour agir !</p>
        `,
        choices: [
            { text: 'üí£ Tenter de saboter', next: 'sabotage' },
            { text: 'üèÉ Chercher de l\'aide', next: 'warn_director' }
        ],
        xp: 25
    },
    sabotage: {
        content: `
            <p>Vous tentez d'effacer les runes, mais une barri√®re magique vous repousse violemment !</p>
            <p>Vous perdez 20 PV !</p>
            <p>Le cercle est prot√©g√©... Il faudra une autre approche.</p>
        `,
        choices: [
            { text: 'üèÉ Partir chercher de l\'aide', next: 'warn_director' }
        ],
        effect: { damage: 20 }
    },
    dungeons_day: {
        content: `
            <p>Les cachots sont moins effrayants en journ√©e, mais toujours sinistres.</p>
            <p>Vous entendez des voix provenant d'une salle de classe - c'est le cours de potions !</p>
        `,
        choices: [
            { text: 'üëÄ Espionner le cours', next: 'spy_potions' },
            { text: 'üîç Explorer plus profond', next: 'dungeons_deep', combat: 'goblin' },
            { text: 'üîô Remonter', next: 'after_class' }
        ]
    },
    spy_potions: {
        content: `
            <p>Le Professeur Malachar enseigne la pr√©paration d'une potion complexe.</p>
            <p>Vous remarquez qu'il semble distrait, regardant souvent vers une porte au fond de la salle...</p>
            <p>La m√™me porte secr√®te que vous avez vue la nuit !</p>
        `,
        choices: [
            { text: 'üö™ Attendre la fin du cours pour explorer', next: 'after_potions' },
            { text: 'üîô Partir', next: 'after_class' }
        ],
        xp: 15
    },
    after_potions: {
        content: `
            <p>Le cours termin√©, le Professeur Malachar s'approche de vous.</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üß™ Professeur Malachar</div>
                <div class="dialogue-text">"Je t'ai vu observer. Tu sais quelque chose, n'est-ce pas ? Viens dans mon bureau, il faut qu'on parle."</div>
            </div>
        `,
        choices: [
            { text: 'üö∂ Le suivre', next: 'malachar_office' },
            { text: 'üèÉ Refuser et partir', next: 'after_class' }
        ]
    },
    malachar_office: {
        content: `
            <p>Dans son bureau, Malachar ferme la porte et lance un sort de silence.</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üß™ Professeur Malachar</div>
                <div class="dialogue-text">"√âcoute bien. Je sais que tu enqu√™tes. Je ne suis pas ton ennemi - je prot√®ge cette √©cole depuis 20 ans. Le vrai danger, c'est quelqu'un que personne ne soup√ßonne..."</div>
            </div>
        `,
        choices: [
            { text: '‚ùì "Qui est-ce ?"', next: 'reveal_traitor' }
        ]
    },
    reveal_traitor: {
        content: `
            <div class="dialogue-box">
                <div class="dialogue-speaker">üß™ Professeur Malachar</div>
                <div class="dialogue-text">"Le concierge, Argus Ombrage. Il √©tait √©l√®ve ici il y a 30 ans... et il est un descendant direct de Magnus Sombral. Il pr√©pare sa lib√©ration depuis des ann√©es !"</div>
            </div>
            <p><em>Le concierge ! Personne ne l'aurait soup√ßonn√© !</em></p>
        `,
        choices: [
            { text: 'üò± "Il faut l\'arr√™ter !"', next: 'plan_action' }
        ],
        xp: 60,
        flag: 'knows_traitor'
    },
    plan_action: {
        content: `
            <div class="dialogue-box">
                <div class="dialogue-speaker">üß™ Professeur Malachar</div>
                <div class="dialogue-text">"Ce soir √† minuit, il accomplira le rituel dans les cachots. Nous serons l√† pour l'arr√™ter. Toi, tu seras notre arme secr√®te - il ne te soup√ßonnera pas."</div>
            </div>
            <p>Il vous donne une <strong>Potion de Force</strong> !</p>
        `,
        choices: [
            { text: 'üí™ "Comptez sur moi !"', next: 'final_quest' }
        ],
        item: { id: 'strength_potion', name: 'Potion de Force', icon: 'üí™', count: 1 },
        flag: 'ally_malachar'
    },
    dungeons_deep: {
        content: `
            <p>Vous vous enfoncez dans les profondeurs des cachots. Un gobelin surgit !</p>
        `,
        choices: [
            { text: '‚öîÔ∏è Combattre !', next: 'deep_explore', combat: 'goblin' }
        ]
    },
    deep_explore: {
        content: `
            <p>Plus profond dans les cachots, vous d√©couvrez une salle ancienne.</p>
            <p>Des cha√Ænes rouill√©es pendent aux murs. C'√©tait une prison autrefois.</p>
            <p>Une inscription sur le mur : "Ici fut enferm√© celui qui ne devait jamais √™tre lib√©r√©"</p>
        `,
        choices: [
            { text: 'üîç Chercher d\'autres indices', next: 'find_clue' },
            { text: 'üîô Remonter', next: 'after_class' }
        ],
        xp: 30
    },
    find_clue: {
        content: `
            <p>Derri√®re une pierre descell√©e, vous trouvez un vieux journal !</p>
            <p>C'est le journal d'un des fondateurs ! Il d√©crit comment ils ont pi√©g√© Magnus Sombral.</p>
            <p><em>"La seule fa√ßon de le d√©truire d√©finitivement est d'utiliser les quatre artefacts des fondateurs ensemble..."</em></p>
        `,
        choices: [
            { text: 'üìñ Continuer √† lire', next: 'journal_end' }
        ],
        item: { id: 'founder_journal', name: 'Journal du Fondateur', icon: 'üìî', count: 1 },
        xp: 45
    },
    journal_end: {
        content: `
            <p>Le journal liste les quatre artefacts :</p>
            <ul style="margin: 15px 0 15px 30px;">
                <li>üé© Le Choixpeau de Griffeor (vol√© !)</li>
                <li>üìø L'Amulette de Serpentis (lieu inconnu)</li>
                <li>üìñ Le Grimoire d'Aquilon (biblioth√®que ?)</li>
                <li>‚öîÔ∏è L'√âp√©e de Blairaud (salle des troph√©es)</li>
            </ul>
            <p><em>Si vous rassemblez ces artefacts, vous pourrez vaincre Magnus d√©finitivement !</em></p>
        `,
        choices: [
            { text: 'üîç Chercher les artefacts', next: 'artifact_hunt' },
            { text: '‚öîÔ∏è Aller directement affronter le danger', next: 'final_quest' }
        ],
        flag: 'knows_artifacts'
    },
    artifact_hunt: {
        content: `
            <p>Vous partez √† la recherche des artefacts !</p>
            <p>Apr√®s de longues recherches, vous trouvez le Grimoire dans la Section Interdite et l'√âp√©e dans la salle des troph√©es (gard√©e par un troll !).</p>
            <p>L'Amulette... √©tait autour du cou du Professeur Darkwood depuis le d√©but !</p>
            <p><em>Vous avez trois artefacts sur quatre. Le Choixpeau est entre les mains de l'ennemi...</em></p>
        `,
        choices: [
            { text: '‚öîÔ∏è Aller au combat final !', next: 'final_quest' }
        ],
        xp: 80,
        flag: 'has_artifacts',
        combat: 'troll'
    },
    talk_professors: {
        content: `
            <p>Vous croisez plusieurs professeurs dans les couloirs. Qui souhaitez-vous consulter ?</p>
        `,
        choices: [
            { text: 'üë©‚Äçüè´ La Directrice', next: 'warn_director' },
            { text: 'üß™ Professeur Malachar', next: 'malachar_office' },
            { text: 'üßô Professeur Darkwood', next: 'confront_darkwood' }
        ]
    },
    library_research: {
        content: `
            <p>Vous passez des heures √† la biblioth√®que, compilant toutes les informations.</p>
            <p>Vous √™tes maintenant pr√™t pour affronter le danger !</p>
            <p><em>+10 √† toutes vos stats !</em></p>
        `,
        choices: [
            { text: '‚öîÔ∏è Aller aux cachots', next: 'final_quest' }
        ],
        xp: 40,
        effect: { attack: 10, defense: 10 }
    },
    final_quest: {
        title: 'Chapitre Final : L\'Affrontement',
        content: `
            <p>Minuit approche. Vous descendez dans les profondeurs des cachots.</p>
            <p>Des torches vertes √©clairent le chemin. Vous entendez une incantation...</p>
            <p>Dans la salle du rituel, vous voyez <strong>Argus Ombrage</strong>, le concierge, tenant le Choixpeau au-dessus d'un cercle de runes !</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üßπ Argus Ombrage</div>
                <div class="dialogue-text">"Enfin ! Apr√®s toutes ces ann√©es ! Mon anc√™tre va rena√Ætre et ensemble, nous d√©truirons cette √©cole qui m'a humili√© !"</div>
            </div>
        `,
        choices: [
            { text: 'üó£Ô∏è "Arr√™tez ! C\'est de la folie !"', next: 'confront_argus' },
            { text: '‚öîÔ∏è Attaquer imm√©diatement !', next: 'attack_argus', combat: 'shadow' },
            { text: 'ü§´ Attendre le bon moment', next: 'wait_moment' }
        ]
    },
    confront_argus: {
        content: `
            <div class="dialogue-box">
                <div class="dialogue-speaker">üßπ Argus Ombrage</div>
                <div class="dialogue-text">"Un √©l√®ve ? Ha ! Tu crois pouvoir m'arr√™ter ? Magnus Sombral √©tait le plus grand sorcier de son √©poque ! Et bient√¥t, il reviendra !"</div>
            </div>
            <p>Il l√®ve sa baguette. Ses yeux brillent d'une lueur d√©mente.</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üßπ Argus Ombrage</div>
                <div class="dialogue-text">"Tu aurais d√ª rester dans ton lit, petit. Maintenant, tu seras le sacrifice parfait !"</div>
            </div>
        `,
        choices: [
            { text: '‚öîÔ∏è Se d√©fendre !', next: 'boss_fight', combat: 'shadow' }
        ]
    },
    wait_moment: {
        content: `
            <p>Vous vous cachez dans l'ombre, attendant le bon moment.</p>
            <p>Soudain, les professeurs Malachar et Darkwood surgissent de l'autre c√¥t√© !</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üß™ Professeur Malachar</div>
                <div class="dialogue-text">"C'est termin√©, Ombrage ! Rends-toi !"</div>
            </div>
            <p>Ombrage ricane et termine son incantation. L'ombre de Magnus commence √† se mat√©rialiser !</p>
        `,
        choices: [
            { text: '‚öîÔ∏è Attaquer pendant la confusion !', next: 'boss_fight', combat: 'shadow' }
        ],
        xp: 30
    },
    attack_argus: {
        content: `
            <p>Vous lancez un sort, mais Ombrage le d√©vie facilement !</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üßπ Argus Ombrage</div>
                <div class="dialogue-text">"Path√©tique ! Tu n'es qu'un enfant !"</div>
            </div>
            <p>Il contre-attaque avec une puissance terrifiante. Le combat commence !</p>
        `,
        choices: [
            { text: '‚öîÔ∏è Combattre !', next: 'boss_fight', combat: 'shadow' }
        ]
    },
    boss_fight: {
        content: `
            <p>Le combat fait rage ! Ombrage canalise la puissance de Magnus Sombral.</p>
            <p>Ses attaques sont d√©vastatrices, mais vous tenez bon !</p>
            <p>C'est le moment de donner tout ce que vous avez !</p>
        `,
        choices: [
            { text: '‚öîÔ∏è COMBAT FINAL !', next: 'victory', combat: 'shadow' }
        ]
    },
    victory: {
        title: 'üèÜ VICTOIRE !',
        content: `
            <p>Avec un dernier sort puissant, vous brisez le rituel !</p>
            <p>L'ombre de Magnus Sombral hurle et se dissipe dans les t√©n√®bres. Ombrage s'effondre, inconscient.</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üë©‚Äçüè´ Directrice √âtoilemer</div>
                <div class="dialogue-text">"Incroyable ! Tu as r√©ussi ! Tu as sauv√© l'√©cole et peut-√™tre le monde magique tout entier !"</div>
            </div>
            <p>Les professeurs vous entourent, impressionn√©s par votre courage.</p>
        `,
        choices: [
            { text: 'üéâ C√©l√©brer la victoire !', next: 'ending' }
        ],
        xp: 200,
        gold: 500
    },
    ending: {
        title: '‚ú® √âPILOGUE ‚ú®',
        content: `
            <p>Les semaines suivantes sont un tourbillon de c√©l√©brations.</p>
            <p>Vous recevez la <strong>M√©daille de l'Ordre de Merlin</strong> pour votre bravoure !</p>
            <p>Le Choixpeau est restaur√© √† sa place, et les objets vol√©s sont r√©cup√©r√©s.</p>
            <p>Argus Ombrage est envoy√© √† la prison magique d'Azkaban pour ses crimes.</p>
            <div class="dialogue-box">
                <div class="dialogue-speaker">üë©‚Äçüè´ Directrice √âtoilemer</div>
                <div class="dialogue-text">"Tu as prouv√© que le courage, la sagesse et la loyaut√© peuvent vaincre les t√©n√®bres. L'√âcole des Sortil√®ges sera toujours ta maison."</div>
            </div>
            <p style="text-align: center; font-size: 1.5em; color: #ffd700; margin-top: 30px;">üèÜ F√âLICITATIONS ! üèÜ</p>
            <p style="text-align: center;">Vous avez termin√© "L'√âcole des Sortil√®ges" !</p>
            <p style="text-align: center; margin-top: 20px;"><em>Merci d'avoir jou√© !</em></p>
        `,
        choices: [
            { text: 'üîÑ Nouvelle Partie', next: 'intro', reset: true }
        ]
    }
};

// ==================== BOUTIQUE ====================
const shopItems = [
    { id: 'potion', name: 'Potion de Soin', icon: 'üß™', price: 25, effect: 'heal', value: 40 },
    { id: 'mana_potion', name: 'Potion de Mana', icon: 'üíô', price: 30, effect: 'mana', value: 50 },
    { id: 'strength_elixir', name: '√âlixir de Force', icon: 'üí™', price: 100, effect: 'attack', value: 5 },
    { id: 'shield_charm', name: 'Charme de Protection', icon: 'üõ°Ô∏è', price: 100, effect: 'defense', value: 5 },
    { id: 'xp_scroll', name: 'Parchemin de Sagesse', icon: 'üìú', price: 150, effect: 'xp', value: 50 }
];

// ==================== FONCTIONS DU JEU ====================

// Cr√©er les particules magiques
function createParticles() {
    const container = document.getElementById('particles');
    for (let i = 0; i < 50; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 15 + 's';
        particle.style.animationDuration = (10 + Math.random() * 10) + 's';
        container.appendChild(particle);
    }
}

// Afficher la cr√©ation de personnage
function showCharacterCreation() {
    document.getElementById('title-screen').style.display = 'none';
    document.getElementById('character-creation').style.display = 'flex';
}

// S√©lectionner une maison
let selectedHouse = '';
function selectHouse(house, element) {
    document.querySelectorAll('.house-btn').forEach(btn => btn.classList.remove('selected'));
    element.classList.add('selected');
    selectedHouse = house;
}

// D√©marrer le jeu
function startGame() {
    const name = document.getElementById('player-name').value.trim() || 'Sorcier Anonyme';
    if (!selectedHouse) {
        showNotification('Choisissez une maison !', 'danger');
        return;
    }
    
    game.player.name = name;
    game.player.house = selectedHouse;
    
    document.getElementById('character-creation').style.display = 'none';
    document.getElementById('game-container').style.display = 'block';
    
    updateUI();
    loadScene('intro');
}

// Mettre √† jour l'interface
function updateUI() {
    document.getElementById('display-name').textContent = game.player.name;
    document.getElementById('display-house').textContent = game.player.house;
    document.getElementById('level-display').textContent = game.player.level;
    document.getElementById('gold-display').textContent = game.player.gold;
    document.getElementById('health-bar').style.width = (game.player.health / game.player.maxHealth * 100) + '%';
    document.getElementById('mana-bar').style.width = (game.player.mana / game.player.maxMana * 100) + '%';
    
    // Mise √† jour des qu√™tes actives
    updateActiveQuest();
    updateQuickSpells();
    updateQuickInventory();
}

// Mettre √† jour la qu√™te active
function updateActiveQuest() {
    const activeQuest = game.quests.find(q => q.active && !q.completed);
    const container = document.getElementById('active-quest');
    
    if (activeQuest) {
        container.innerHTML = `
            <div class="quest-item active">
                <div class="quest-title">üìå ${activeQuest.title}</div>
                <div class="quest-desc">${activeQuest.desc}</div>
                <div class="quest-reward">üéÅ ${activeQuest.reward.xp} XP, ${activeQuest.reward.gold} Or</div>
            </div>
        `;
    } else {
        container.innerHTML = '<p style="opacity: 0.6; font-size: 0.9em;">Aucune qu√™te active</p>';
    }
}

// Mettre √† jour les sorts rapides
function updateQuickSpells() {
    const container = document.getElementById('quick-spells');
    container.innerHTML = game.spells.slice(0, 4).map(spell => `
        <div class="spell-item" title="${spell.desc}">
            <span class="spell-icon">${spell.icon}</span>
            <div class="spell-info">
                <div class="spell-name">${spell.name}</div>
                <div class="spell-cost">${spell.cost} mana</div>
            </div>
        </div>
    `).join('');
}

// Mettre √† jour l'inventaire rapide
function updateQuickInventory() {
    const container = document.getElementById('quick-inventory');
    let html = '';
    
    for (let i = 0; i < 8; i++) {
        if (game.inventory[i]) {
            html += `
                <div class="inventory-slot" onclick="useItem(${i})" title="${game.inventory[i].name}">
                    ${game.inventory[i].icon}
                    ${game.inventory[i].count > 1 ? `<span class="item-count">${game.inventory[i].count}</span>` : ''}
                </div>
            `;
        } else {
            html += '<div class="inventory-slot"></div>';
        }
    }
    
    container.innerHTML = html;
}

// Charger une sc√®ne
function loadScene(sceneId) {
    game.storyScene = sceneId;
    const scene = storyScenes[sceneId];
    
    if (!scene) {
        console.error('Sc√®ne non trouv√©e:', sceneId);
        return;
    }
    
    // G√©rer les effets de la sc√®ne
    if (scene.xp) addXP(scene.xp);
    if (scene.gold) game.player.gold += scene.gold;
    if (scene.flag) game.flags[scene.flag] = true;
    if (scene.item) addItem(scene.item);
    if (scene.spell) game.spells.push(scene.spell);
    if (scene.effect) applyEffect(scene.effect);
    if (scene.completeQuest) completeQuest(scene.completeQuest);
    if (scene.activateQuest) activateQuest(scene.activateQuest);
    if (scene.unlockLocation) game.locations[scene.unlockLocation].unlocked = true;
    if (scene.unlockAllLocations) {
        Object.keys(game.locations).forEach(loc => game.locations[loc].unlocked = true);
    }
    
    // Construire le contenu
    let html = '';
    if (scene.title) {
        html += `<h2>${scene.title}</h2>`;
    }
    
    html += `<div class="story-text">${scene.content}</div>`;
    
    // Remplacer les variables
    html = html.replace(/<span class="house-name-display"><\/span>/g, game.player.house);
    html = html.replace(/class="house-name-display"/g, `>${game.player.house}<`);
    
    // Ajouter les choix
    if (scene.choices && scene.choices.length > 0) {
        html += '<div class="choice-container">';
        scene.choices.forEach((choice, index) => {
            // V√©rifier les conditions
            let disabled = false;
            let disabledReason = '';
            
            if (choice.requireItem) {
                const hasItem = game.inventory.some(item => item && item.id === choice.requireItem);
                if (!hasItem) {
                    disabled = true;
                    disabledReason = ' (Objet requis manquant)';
                }
            }
            
            if (choice.requireSpell) {
                const hasSpell = game.spells.some(spell => spell.id === choice.requireSpell);
                if (!hasSpell) {
                    disabled = true;
                    disabledReason = ' (Sort requis non appris)';
                }
            }
            
            html += `
                <button class="choice-btn" 
                    onclick="makeChoice(${index})" 
                    ${disabled ? 'disabled style="opacity:0.5"' : ''}>
                    ${choice.text}${disabledReason}
                </button>
            `;
        });
        html += '</div>';
    }
    
    document.getElementById('story-content').innerHTML = html;
    updateUI();
}

// Faire un choix
function makeChoice(choiceIndex) {
    const scene = storyScenes[game.storyScene];
    const choice = scene.choices[choiceIndex];
    
    if (choice.xp) addXP(choice.xp);
    if (choice.flag) game.flags[choice.flag] = true;
    if (choice.item) addItem(choice.item);
    if (choice.reset) {
        resetGame();
        return;
    }
    
    if (choice.combat) {
        startCombat(choice.combat, choice.next);
    } else {
        loadScene(choice.next);
    }
}

// Ajouter un objet √† l'inventaire
function addItem(item) {
    if (typeof item === 'string') {
        // Simple item ID
        const existingItem = game.inventory.find(i => i && i.id === item);
        if (existingItem) {
            existingItem.count++;
        } else {
            game.inventory.push({ id: item, name: item, icon: 'üì¶', count: 1 });
        }
    } else {
        // Full item object
        const existingItem = game.inventory.find(i => i && i.id === item.id);
        if (existingItem) {
            existingItem.count += item.count || 1;
        } else {
            game.inventory.push({ ...item, count: item.count || 1 });
        }
    }
    showNotification(`üì¶ Objet obtenu : ${item.name || item}`, 'success');
}

// Utiliser un objet
function useItem(index) {
    const item = game.inventory[index];
    if (!item) return;
    
    switch (item.effect) {
        case 'heal':
            game.player.health = Math.min(game.player.maxHealth, game.player.health + item.value);
            showNotification(`‚ù§Ô∏è +${item.value} PV !`, 'success');
            break;
        case 'mana':
            game.player.mana = Math.min(game.player.maxMana, game.player.mana + item.value);
            showNotification(`üíô +${item.value} Mana !`, 'success');
            break;
    }
    
    item.count--;
    if (item.count <= 0) {
        game.inventory.splice(index, 1);
    }
    
    updateUI();
}

// Appliquer un effet
function applyEffect(effect) {
    if (effect.maxHealth) game.player.maxHealth += effect.maxHealth;
    if (effect.maxMana) game.player.maxMana += effect.maxMana;
    if (effect.attack) game.player.attack += effect.attack;
    if (effect.defense) game.player.defense += effect.defense;
    if (effect.damage) game.player.health -= effect.damage;
    if (effect.fullRestore) {
        game.player.health = game.player.maxHealth;
        game.player.mana = game.player.maxMana;
    }
    
    // S'assurer que la sant√© ne d√©passe pas le max
    game.player.health = Math.min(game.player.health, game.player.maxHealth);
    game.player.mana = Math.min(game.player.mana, game.player.maxMana);
}

// Ajouter de l'XP
function addXP(amount) {
    game.player.xp += amount;
    showNotification(`‚ú® +${amount} XP !`, 'success');
    
    while (game.player.xp >= game.player.xpToNext) {
        game.player.xp -= game.player.xpToNext;
        game.player.level++;
        game.player.xpToNext = Math.floor(game.player.xpToNext * 1.5);
        game.player.maxHealth += 10;
        game.player.maxMana += 10;
        game.player.health = game.player.maxHealth;
        game.player.mana = game.player.maxMana;
        game.player.attack += 3;
        game.player.defense += 2;
        showNotification(`üéâ Niveau ${game.player.level} atteint !`, 'success');
    }
}

// Compl√©ter une qu√™te
function completeQuest(questId) {
    const quest = game.quests.find(q => q.id === questId);
    if (quest && !quest.completed) {
        quest.completed = true;
        quest.active = false;
        addXP(quest.reward.xp);
        game.player.gold += quest.reward.gold;
        showNotification(`üìú Qu√™te termin√©e : ${quest.title}`, 'success');
    }
}

// Activer une qu√™te
function activateQuest(questId) {
    const quest = game.quests.find(q => q.id === questId);
    if (quest && !quest.active) {
        quest.active = true;
        showNotification(`üìú Nouvelle qu√™te : ${quest.title}`, 'info');
    }
}

// ==================== SYST√àME DE COMBAT ====================

function startCombat(enemyType, nextScene) {
    const enemy = { ...enemies[enemyType] };
    enemy.maxHealth = enemy.health;
    
    game.combat = {
        enemy: enemy,
        nextScene: nextScene,
        turn: 'player',
        log: []
    };
    
    // Afficher l'√©cran de combat
    document.getElementById('combat-screen').style.display = 'block';
    document.getElementById('combat-player-name').textContent = game.player.name;
    document.getElementById('combat-player-avatar').textContent = 'üßô';
    document.getElementById('combat-enemy-name').textContent = enemy.name;
    document.getElementById('combat-enemy-avatar').textContent = enemy.icon;
    
    updateCombatUI();
    addCombatLog(`‚öîÔ∏è Combat contre ${enemy.name} !`, 'info');
    renderCombatActions();
}

function updateCombatUI() {
    const playerHealthPercent = (game.player.health / game.player.maxHealth) * 100;
    const enemyHealthPercent = (game.combat.enemy.health / game.combat.enemy.maxHealth) * 100;
    
    document.getElementById('combat-player-health').style.width = playerHealthPercent + '%';
    document.getElementById('combat-player-hp').textContent = Math.max(0, game.player.health);
    document.getElementById('combat-enemy-health').style.width = enemyHealthPercent + '%';
    document.getElementById('combat-enemy-hp').textContent = Math.max(0, game.combat.enemy.health);
}

function addCombatLog(message, type = 'info') {
    const log = document.getElementById('combat-log');
    log.innerHTML += `<p class="${type}">${message}</p>`;
    log.scrollTop = log.scrollHeight;
}

function renderCombatActions() {
    const potions = game.inventory.filter(i => i && i.effect === 'heal');
    const potionCount = potions.reduce((sum, p) => sum + p.count, 0);
    
    document.getElementById('combat-actions').innerHTML = `
        <button class="combat-btn attack" onclick="combatAction('attack')">‚öîÔ∏è Attaquer</button>
        <button class="combat-btn spell" onclick="combatAction('stupefix')" ${game.player.mana < 20 ? 'disabled' : ''}>
            ‚ö° Stup√©fix (20 mana)
        </button>
        <button class="combat-btn spell" onclick="combatAction('incendio')" ${game.player.mana < 35 ? 'disabled' : ''}>
            üî• Incendio (35 mana)
        </button>
        <button class="combat-btn item" onclick="combatAction('heal')" ${potionCount === 0 ? 'disabled' : ''}>
            üß™ Potion (${potionCount})
        </button>
        <button class="combat-btn flee" onclick="combatAction('flee')">üèÉ Fuir</button>
    `;
}

function combatAction(action) {
    if (game.combat.turn !== 'player') return;
    
    let damage = 0;
    let message = '';
    
    switch (action) {
        case 'attack':
            damage = game.player.attack + Math.floor(Math.random() * 10);
            game.combat.enemy.health -= damage;
            message = `‚öîÔ∏è Vous infligez ${damage} d√©g√¢ts !`;
            addCombatLog(message, 'damage');
            showSpellEffect('‚öîÔ∏è');
            break;
            
        case 'stupefix':
            if (game.player.mana < 20) return;
            game.player.mana -= 20;
            damage = 30 + Math.floor(Math.random() * 15);
            game.combat.enemy.health -= damage;
            message = `‚ö° Stup√©fix ! ${damage} d√©g√¢ts !`;
            addCombatLog(message, 'damage');
            showSpellEffect('‚ö°');
            break;
            
        case 'incendio':
            if (game.player.mana < 35) return;
            game.player.mana -= 35;
            damage = 50 + Math.floor(Math.random() * 20);
            game.combat.enemy.health -= damage;
            message = `üî• Incendio ! ${damage} d√©g√¢ts !`;
            addCombatLog(message, 'damage');
            showSpellEffect('üî•');
            break;
            
        case 'heal':
            const potion = game.inventory.find(i => i && i.effect === 'heal');
            if (!potion) return;
            const healAmount = potion.value || 40;
            game.player.health = Math.min(game.player.maxHealth, game.player.health + healAmount);
            potion.count--;
            if (potion.count <= 0) {
                game.inventory = game.inventory.filter(i => i !== potion);
            }
            addCombatLog(`‚ù§Ô∏è Vous r√©cup√©rez ${healAmount} PV !`, 'heal');
            showSpellEffect('‚ù§Ô∏è');
            break;
            
        case 'flee':
            if (Math.random() > 0.5) {
                addCombatLog('üèÉ Vous fuyez le combat !', 'info');
                setTimeout(() => endCombat(false), 1000);
                return;
            } else {
                addCombatLog('‚ùå Fuite √©chou√©e !', 'damage');
            }
            break;
    }
    
    updateCombatUI();
    updateUI();
    
    // V√©rifier si l'ennemi est vaincu
    if (game.combat.enemy.health <= 0) {
        setTimeout(() => endCombat(true), 1000);
        return;
    }
    
    // Tour de l'ennemi
    game.combat.turn = 'enemy';
    setTimeout(enemyTurn, 1500);
}

function enemyTurn() {
    if (game.combat.enemy.health <= 0) return;
    
    const enemyDamage = Math.max(1, game.combat.enemy.attack - game.player.defense + Math.floor(Math.random() * 10));
    game.player.health -= enemyDamage;
    
    addCombatLog(`${game.combat.enemy.icon} ${game.combat.enemy.name} inflige ${enemyDamage} d√©g√¢ts !`, 'damage');
    updateCombatUI();
    updateUI();
    
    // V√©rifier si le joueur est vaincu
    if (game.player.health <= 0) {
        addCombatLog('üíÄ Vous avez √©t√© vaincu...', 'damage');
        setTimeout(() => {
            game.player.health = Math.floor(game.player.maxHealth / 2);
            document.getElementById('combat-screen').style.display = 'none';
            loadScene('dormitory');
            showNotification('Vous vous r√©veillez √† l\'infirmerie...', 'danger');
        }, 2000);
        return;
    }
    
    game.combat.turn = 'player';
    renderCombatActions();
}

function endCombat(victory) {
    document.getElementById('combat-screen').style.display = 'none';
    
    if (victory) {
        addXP(game.combat.enemy.xp);
        game.player.gold += game.combat.enemy.gold;
        showNotification(`üèÜ Victoire ! +${game.combat.enemy.xp} XP, +${game.combat.enemy.gold} Or`, 'success');
    }
    
    if (game.combat.nextScene) {
        loadScene(game.combat.nextScene);
    }
    
    game.combat = null;
    updateUI();
}

function showSpellEffect(emoji) {
    const effect = document.createElement('div');
    effect.className = 'spell-effect';
    effect.textContent = emoji;
    document.body.appendChild(effect);
    setTimeout(() => effect.remove(), 1000);
}

// ==================== NAVIGATION ====================

function navigate(section) {
    // Mettre √† jour les boutons actifs
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    event.target.closest('.nav-btn').classList.add('active');
    
    switch (section) {
        case 'story':
            loadScene(game.storyScene);
            break;
        case 'quests':
            showQuests();
            break;
        case 'map':
            showMap();
            break;
        case 'spells':
            showSpells();
            break;
        case 'inventory':
            showInventory();
            break;
        case 'shop':
            showShop();
            break;
    }
}

function showQuests() {
    let html = '<h2>üìú Journal de Qu√™tes</h2>';
    
    // Qu√™tes actives
    const activeQuests = game.quests.filter(q => q.active && !q.completed);
    if (activeQuests.length > 0) {
        html += '<h3 style="color: #ff8800; margin: 20px 0 10px;">‚è≥ En cours</h3>';
        activeQuests.forEach(quest => {
            html += `
                <div class="quest-item active">
                    <div class="quest-title">üìå ${quest.title}</div>
                    <div class="quest-desc">${quest.desc}</div>
                    <div class="quest-reward">üéÅ R√©compense : ${quest.reward.xp} XP, ${quest.reward.gold} Or</div>
                </div>
            `;
        });
    }
    
    // Qu√™tes compl√©t√©es
    const completedQuests = game.quests.filter(q => q.completed);
    if (completedQuests.length > 0) {
        html += '<h3 style="color: #44ff44; margin: 20px 0 10px;">‚úÖ Termin√©es</h3>';
        completedQuests.forEach(quest => {
            html += `
                <div class="quest-item completed">
                    <div class="quest-title">‚úì ${quest.title}</div>
                    <div class="quest-desc">${quest.desc}</div>
                </div>
            `;
        });
    }
    
    // Qu√™tes √† d√©couvrir
    const lockedQuests = game.quests.filter(q => !q.active && !q.completed);
    if (lockedQuests.length > 0) {
        html += '<h3 style="color: #888; margin: 20px 0 10px;">üîí √Ä d√©couvrir</h3>';
        html += '<p style="opacity: 0.6;">Continuez l\'aventure pour d√©bloquer plus de qu√™tes...</p>';
    }
    
    document.getElementById('story-content').innerHTML = html;
}

function showMap() {
    let html = '<h2>üó∫Ô∏è Carte de l\'√âcole</h2>';
    html += '<div class="map-container">';
    
    Object.entries(game.locations).forEach(([id, loc]) => {
        const isCurrent = id === game.currentLocation;
        const isLocked = !loc.unlocked;
        
        html += `
            <div class="map-location ${isCurrent ? 'current' : ''} ${isLocked ? 'locked' : ''}"
                 onclick="${isLocked ? '' : `travelTo('${id}')`}">
                <div class="location-icon">${loc.icon}</div>
                <h4>${loc.name}</h4>
                ${isCurrent ? '<p style="color: #44ff44; font-size: 0.8em;">üìç Vous √™tes ici</p>' : ''}
                ${isLocked ? '<p style="color: #ff4444; font-size: 0.8em;">üîí Verrouill√©</p>' : ''}
            </div>
        `;
    });
    
    html += '</div>';
    document.getElementById('story-content').innerHTML = html;
}

function travelTo(locationId) {
    if (!game.locations[locationId].unlocked) return;
    
    game.currentLocation = locationId;
    showNotification(`üìç Vous √™tes √† : ${game.locations[locationId].name}`, 'info');
    
    // Charger une sc√®ne correspondante si elle existe
    const sceneMap = {
        'library': 'library_day',
        'dungeons': 'dungeons_day',
        'tower': 'tower_visit',
        'forest': 'forest_entrance',
        'dormitory': 'dormitory',
        'hall': 'great_hall'
    };
    
    if (sceneMap[locationId]) {
        loadScene(sceneMap[locationId]);
    } else {
        showMap();
    }
}

function showSpells() {
    let html = '<h2>‚ú® Grimoire de Sorts</h2>';
    html += '<div style="display: grid; gap: 15px;">';
    
    game.spells.forEach(spell => {
        html += `
            <div class="spell-item" style="padding: 15px;">
                <span class="spell-icon" style="font-size: 2em;">${spell.icon}</span>
                <div class="spell-info" style="flex: 1;">
                    <div class="spell-name" style="font-size: 1.2em; color: #ffd700;">${spell.name}</div>
                    <div class="spell-cost">Co√ªt : ${spell.cost} mana</div>
                    <div style="margin-top: 5px; opacity: 0.8;">${spell.desc}</div>
                    ${spell.damage > 0 ? `<div style="color: #ff6666;">D√©g√¢ts : ${spell.damage}</div>` : ''}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    document.getElementById('story-content').innerHTML = html;
}

function showInventory() {
    let html = '<h2>üéí Inventaire</h2>';
    
    if (game.inventory.length === 0) {
        html += '<p style="opacity: 0.7;">Votre inventaire est vide.</p>';
    } else {
        html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">';
        
        game.inventory.forEach((item, index) => {
            if (item) {
                html += `
                    <div class="spell-item" style="padding: 15px; cursor: pointer;" onclick="useItemFromInventory(${index})">
                        <span style="font-size: 2em;">${item.icon}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #ffd700;">${item.name}</div>
                            <div style="font-size: 0.9em; opacity: 0.8;">Quantit√© : ${item.count}</div>
                            ${item.effect ? `<div style="color: #66ff66; font-size: 0.85em;">Cliquez pour utiliser</div>` : ''}
                        </div>
                    </div>
                `;
            }
        });
        
        html += '</div>';
    }
    
    // Afficher les stats du joueur
    html += `
        <h3 style="color: #ffd700; margin-top: 30px;">üìä Statistiques</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 15px;">
            <div class="spell-item" style="padding: 10px; text-align: center;">
                <div style="font-size: 1.5em;">‚öîÔ∏è</div>
                <div>Attaque</div>
                <div style="color: #ffd700; font-size: 1.3em;">${game.player.attack}</div>
            </div>
            <div class="spell-item" style="padding: 10px; text-align: center;">
                <div style="font-size: 1.5em;">üõ°Ô∏è</div>
                <div>D√©fense</div>
                <div style="color: #ffd700; font-size: 1.3em;">${game.player.defense}</div>
            </div>
            <div class="spell-item" style="padding: 10px; text-align: center;">
                <div style="font-size: 1.5em;">‚ù§Ô∏è</div>
                <div>PV Max</div>
                <div style="color: #ffd700; font-size: 1.3em;">${game.player.maxHealth}</div>
            </div>
            <div class="spell-item" style="padding: 10px; text-align: center;">
                <div style="font-size: 1.5em;">üíô</div>
                <div>Mana Max</div>
                <div style="color: #ffd700; font-size: 1.3em;">${game.player.maxMana}</div>
            </div>
        </div>
    `;
    
    document.getElementById('story-content').innerHTML = html;
}

function useItemFromInventory(index) {
    const item = game.inventory[index];
    if (!item || !item.effect) return;
    
    switch (item.effect) {
        case 'heal':
            if (game.player.health >= game.player.maxHealth) {
                showNotification('Votre sant√© est d√©j√† au maximum !', 'info');
                return;
            }
            game.player.health = Math.min(game.player.maxHealth, game.player.health + (item.value || 40));
            showNotification(`‚ù§Ô∏è +${item.value || 40} PV !`, 'success');
            break;
        case 'mana':
            if (game.player.mana >= game.player.maxMana) {
                showNotification('Votre mana est d√©j√† au maximum !', 'info');
                return;
            }
            game.player.mana = Math.min(game.player.maxMana, game.player.mana + (item.value || 50));
            showNotification(`üíô +${item.value || 50} Mana !`, 'success');
            break;
        default:
            showNotification('Cet objet ne peut pas √™tre utilis√© ici.', 'info');
            return;
    }
    
    item.count--;
    if (item.count <= 0) {
        game.inventory.splice(index, 1);
    }
    
    updateUI();
    showInventory();
}

function showShop() {
    let html = '<h2>üè™ Boutique Magique</h2>';
    html += `<p style="margin-bottom: 20px;">üí∞ Or disponible : <span style="color: #ffd700; font-size: 1.2em;">${game.player.gold}</span></p>`;
    html += '<div class="shop-grid">';
    
    shopItems.forEach(item => {
        const canAfford = game.player.gold >= item.price;
        html += `
            <div class="shop-item">
                <div class="item-icon">${item.icon}</div>
                <h4>${item.name}</h4>
                <p style="font-size: 0.85em; opacity: 0.8;">
                    ${item.effect === 'heal' ? `Restaure ${item.value} PV` : ''}
                    ${item.effect === 'mana' ? `Restaure ${item.value} Mana` : ''}
                    ${item.effect === 'attack' ? `+${item.value} Attaque (permanent)` : ''}
                    ${item.effect === 'defense' ? `+${item.value} D√©fense (permanent)` : ''}
                    ${item.effect === 'xp' ? `+${item.value} XP` : ''}
                </p>
                <div class="price">üí∞ ${item.price} Or</div>
                <button class="buy-btn" onclick="buyItem('${item.id}')" ${!canAfford ? 'disabled' : ''}>
                    ${canAfford ? 'Acheter' : 'Pas assez d\'or'}
                </button>
            </div>
        `;
    });
    
    html += '</div>';
    document.getElementById('story-content').innerHTML = html;
}

function buyItem(itemId) {
    const shopItem = shopItems.find(i => i.id === itemId);
    if (!shopItem || game.player.gold < shopItem.price) {
        showNotification('Pas assez d\'or !', 'danger');
        return;
    }
    
    game.player.gold -= shopItem.price;
    
    // Appliquer l'effet ou ajouter √† l'inventaire
    switch (shopItem.effect) {
        case 'attack':
            game.player.attack += shopItem.value;
            showNotification(`‚öîÔ∏è +${shopItem.value} Attaque !`, 'success');
            break;
        case 'defense':
            game.player.defense += shopItem.value;
            showNotification(`üõ°Ô∏è +${shopItem.value} D√©fense !`, 'success');
            break;
        case 'xp':
            addXP(shopItem.value);
            break;
        default:
            // Ajouter √† l'inventaire
            addItem({
                id: shopItem.id,
                name: shopItem.name,
                icon: shopItem.icon,
                count: 1,
                effect: shopItem.effect,
                value: shopItem.value
            });
            break;
    }
    
    updateUI();
    showShop();
}

// ==================== NOTIFICATIONS ====================

function showNotification(message, type = 'info') {
    // Supprimer les anciennes notifications
    document.querySelectorAll('.notification').forEach(n => n.remove());
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => notification.remove(), 3000);
}

// ==================== RESET DU JEU ====================

function resetGame() {
    game = {
        player: {
            name: '',
            house: '',
            level: 1,
            xp: 0,
            xpToNext: 100,
            health: 100,
            maxHealth: 100,
            mana: 100,
            maxMana: 100,
            gold: 50,
            attack: 15,
            defense: 5
        },
        inventory: [
            { id: 'potion', name: 'Potion de Soin', icon: 'üß™', count: 3, effect: 'heal', value: 40 },
            { id: 'mana_potion', name: 'Potion de Mana', icon: 'üíô', count: 2, effect: 'mana', value: 50 }
        ],
        spells: [
            { id: 'lumos', name: 'Lumos', icon: 'üí°', cost: 5, damage: 0, desc: 'Illumine les t√©n√®bres' },
            { id: 'stupefix', name: 'Stup√©fix', icon: '‚ö°', cost: 20, damage: 30, desc: 'Attaque paralysante' },
            { id: 'incendio', name: 'Incendio', icon: 'üî•', cost: 35, damage: 50, desc: 'Boule de feu' },
            { id: 'protego', name: 'Protego', icon: 'üõ°Ô∏è', cost: 15, damage: 0, desc: 'Bouclier magique' }
        ],
        quests: [
            { id: 'q1', title: 'Premier Jour', desc: 'Explorez l\'√©cole et trouvez votre dortoir', active: true, completed: false, reward: { xp: 50, gold: 25 } },
            { id: 'q2', title: 'Le Myst√®re de la Biblioth√®que', desc: 'Enqu√™tez sur les bruits √©tranges', active: false, completed: false, reward: { xp: 100, gold: 50 } },
            { id: 'q3', title: 'L\'Ombre des Cachots', desc: 'D√©couvrez le secret des cachots', active: false, completed: false, reward: { xp: 150, gold: 100 } }
        ],
        locations: {
            entrance: { name: 'Grande Entr√©e', icon: 'üö™', unlocked: true },
            hall: { name: 'Grande Salle', icon: 'üèõÔ∏è', unlocked: true },
            library: { name: 'Biblioth√®que', icon: 'üìö', unlocked: true },
            classroom: { name: 'Salle de Cours', icon: 'üéì', unlocked: true },
            dormitory: { name: 'Dortoir', icon: 'üõèÔ∏è', unlocked: true },
            forbidden: { name: 'Section Interdite', icon: '‚ö†Ô∏è', unlocked: false },
            dungeons: { name: 'Cachots', icon: 'üïØÔ∏è', unlocked: false },
            tower: { name: 'Tour d\'Astronomie', icon: 'üî≠', unlocked: false },
            forest: { name: 'For√™t Interdite', icon: 'üå≤', unlocked: false }
        },
        currentLocation: 'entrance',
        storyScene: 'intro',
        flags: {},
        combat: null
    };
    
    selectedHouse = '';
    
    document.getElementById('game-container').style.display = 'none';
    document.getElementById('combat-screen').style.display = 'none';
    document.getElementById('character-creation').style.display = 'none';
    document.getElementById('title-screen').style.display = 'flex';
    document.getElementById('player-name').value = '';
    document.querySelectorAll('.house-btn').forEach(btn => btn.classList.remove('selected'));
}

// ==================== SAUVEGARDE / CHARGEMENT ====================

function saveGame() {
    localStorage.setItem('magicSchoolSave', JSON.stringify(game));
    showNotification('üíæ Partie sauvegard√©e !', 'success');
}

function loadGame() {
    const save = localStorage.getItem('magicSchoolSave');
    if (save) {
        game = JSON.parse(save);
        document.getElementById('title-screen').style.display = 'none';
        document.getElementById('character-creation').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        updateUI();
        loadScene(game.storyScene);
        showNotification('üìÇ Partie charg√©e !', 'success');
        return true;
    }
    return false;
}

// ==================== INITIALISATION ====================

document.addEventListener('DOMContentLoaded', () => {
    createParticles();
    
    // V√©rifier s'il y a une sauvegarde
    if (localStorage.getItem('magicSchoolSave')) {
        const titleScreen = document.getElementById('title-screen');
        const loadBtn = document.createElement('button');
        loadBtn.className = 'start-btn';
        loadBtn.style.marginTop = '15px';
        loadBtn.style.background = 'linear-gradient(135deg, #2a4a8a, #1a3a6a)';
        loadBtn.innerHTML = 'üìÇ Charger la Partie';
        loadBtn.onclick = loadGame;
        titleScreen.appendChild(loadBtn);
    }
});

// Sauvegarde automatique toutes les 2 minutes
setInterval(() => {
    if (game.player.name) {
        localStorage.setItem('magicSchoolSave', JSON.stringify(game));
    }
}, 120000);

// Raccourcis clavier
document.addEventListener('keydown', (e) => {
    if (e.key === 's' && e.ctrlKey) {
        e.preventDefault();
        saveGame();
    }
});
</script>
</body>
</html>



